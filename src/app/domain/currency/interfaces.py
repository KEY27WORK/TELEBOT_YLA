# üí± app/domain/currency/interfaces.py
"""
üí± –î–æ–º–µ–Ω–Ω–æ-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω—ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏ —Ç–∞ DTO –¥–ª—è –≤–∞–ª—é—Ç–∏.

üîπ `Money` + `IMoneyConverter` ‚Äî –æ—Å–Ω–æ–≤–Ω–∏–π Decimal-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∏–π API.
üîπ `ICurrencyConverter` ‚Äî –ª–µ–≥–∞—Å—ñ float-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ @deprecated.
üîπ `ICurrencyRatesProvider` ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä –∫—É—Ä—Å—ñ–≤, —è–∫–∏–π –≤–∏–¥–∞—î snapshot-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∏.
"""

from __future__ import annotations                                                   # ‚è≥ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ forward references

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                                                       # üßæ –Ñ–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
from dataclasses import dataclass                                                    # üß± DTO –¥–ª—è –≥—Ä–æ—à–µ–π
from decimal import Decimal                                                          # üíµ –¢–æ—á–Ω—ñ –≥—Ä–æ—à–æ–≤—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è
from typing import Dict, NewType, Protocol, Union                                    # üß∞ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∏

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from typing_extensions import deprecated                                             # üï∞Ô∏è –ú–∞—Ä–∫–µ—Ä –∑–∞—Å—Ç–∞—Ä—ñ–ª–æ–≥–æ API

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.shared.utils.logger import LOG_NAME                                         # üè∑Ô∏è –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å –ª–æ–≥–µ—Ä–∞


# ================================
# üßæ –õ–û–ì–ï–† –ú–û–î–£–õ–Ø
# ================================
MODULE_LOGGER_NAME: str = f"{LOG_NAME}.domain.currency.interfaces"                   # üè∑Ô∏è –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å
logger = logging.getLogger(MODULE_LOGGER_NAME)                                       # üßæ –ú–æ–¥—É–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä
logger.debug("üí± currency.interfaces —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ")                                   # üöÄ –§—ñ–∫—Å—É—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é


# ================================
# üí± –¢–ò–ü–ò –¢–ê DTO
# ================================
CurrencyCode = NewType("CurrencyCode", str)                                        # üî§ ISO-4217 –∫–æ–¥ –≤–∞–ª—é—Ç–∏
logger.debug("üî§ CurrencyCode NewType —Å—Ç–≤–æ—Ä–µ–Ω–æ")                                     # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç—É—î–º–æ –∞–ª—ñ–∞—Å


@dataclass(frozen=True, slots=True)
class Money:
    """
    –ù–µ–≤—ñ–¥'—î–º–Ω–∏–π –≥—Ä–æ—à–æ–≤–∏–π DTO —ñ–∑ Decimal-—Å—É–º–æ—é —Ç–∞ CurrencyCode.
    """

    amount: Decimal                                                                  # üíµ –°—É–º–∞ –≤ —Ç–æ—á–Ω–æ–º—É Decimal
    currency: CurrencyCode                                                           # üí± –ö–æ–¥ –≤–∞–ª—é—Ç–∏ (ISO-4217)

    def __post_init__(self) -> None:
        """–§—ñ–∫—Å—É—î —Å—É—Ç–Ω—ñ—Å—Ç—å —É –ª–æ–≥–∞—Ö —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —â–æ amount –Ω–µ NaN."""

        logger.debug(
            "üíµ Money —Å—Ç–≤–æ—Ä–µ–Ω–æ | amount=%s currency=%s",
            self.amount,
            self.currency,
        )                                                                             # üßæ –í—ñ–¥—Å–ª—ñ–¥–∫–æ–≤—É—î–º–æ DTO
        if self.amount.is_nan():                                                     # üö´ –ù–µ –¥–æ–∑–≤–æ–ª—è—î–º–æ NaN —É –≥—Ä–æ—à–∞—Ö
            logger.warning(
                "‚ö†Ô∏è Money amount is NaN | currency=%s",
                self.currency,
            )                                                                         # ‚ö†Ô∏è –§—ñ–∫—Å—É—î–º–æ –∞–Ω–æ–º–∞–ª—ñ—é


class CurrencyRateNotFoundError(ValueError):
    """–î–æ–º–µ–Ω–Ω–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π –≤–∏–Ω—è—Ç–æ–∫ –¥–ª—è –≤—ñ–¥—Å—É—Ç–Ω—å–æ–≥–æ –∫—É—Ä—Å—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó."""

    def __init__(
        self,
        from_currency: Union[str, CurrencyCode],
        to_currency: Union[str, CurrencyCode],
    ) -> None:
        self.from_currency: str = str(from_currency)                                  # üîÅ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ str –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        self.to_currency: str = str(to_currency)
        message: str = (
            f"Exchange rate from {self.from_currency} to {self.to_currency} not found."
        )                                                                             # üìù –ì–æ—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–º–∏–ª–∫–∏
        logger.error("üö´ %s", message)                                              # üö´ –õ–æ–≥—É—î–º–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫—É—Ä—Å
        super().__init__(message)                                                     # üß± –í–∏–∫–ª–∏–∫–∞—î–º–æ ValueError —ñ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º


# ================================
# üîÅ –Ü–ù–¢–ï–†–§–ï–ô–°–ò –ö–û–ù–í–ï–†–¢–ê–¶–Ü–á
# ================================
@deprecated("–õ–µ–≥–∞—Å—ñ float-API. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ IMoneyConverter.")
class ICurrencyConverter(Protocol):
    """@deprecated: —Å—Ç–∞—Ä–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π float-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∑–∞–ª–∏—à–µ–Ω–∏–π –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ."""

    def convert(self, amount: float, from_currency: str, to_currency: str) -> float:
        """–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ —Å—É–º—É —É float (–ª–µ–≥–∞—Å—ñ)."""
        ...                                                                          # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —É —Å–ø–∞–¥–∫–æ—î–º—Ü—è—Ö


class IMoneyConverter(Protocol):
    """–ù–æ–≤–∏–π —Ç–æ—á–Ω–∏–π Decimal-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó."""

    def convert_money(self, money: Money, to_currency: CurrencyCode) -> Money:
        """–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ Money —É –∑–∞–¥–∞–Ω—É –≤–∞–ª—é—Ç—É, –ø–æ–≤–µ—Ä—Ç–∞—é—á–∏ –Ω–æ–≤–∏–π Money."""
        ...                                                                          # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —É —Å–ø–∞–¥–∫–æ—î–º—Ü—è—Ö


# ================================
# üìà –ö–û–ù–¢–†–ê–ö–¢ –ü–†–û–í–ê–ô–î–ï–†–ê –ö–£–†–°–Ü–í
# ================================
class ICurrencyRatesProvider(Protocol):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∫—É—Ä—Å—ñ–≤, —è–∫–∏–π –≤—ñ–¥–¥–∞—î snapshot-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∏.
    –ó–∞–±–µ–∑–ø–µ—á—É—î Decimal-–ø–µ—Ä—à–∏–π –ø—ñ–¥—Ö—ñ–¥ —ñ lazy –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
    """

    async def initialize(self) -> None:
        """–ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –∫–µ—à—ñ —Ç–∞ —Å–ø–∏—Å–æ–∫ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏—Ö –≤–∞–ª—é—Ç."""
        ...                                                                          # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —É —Å–ø–∞–¥–∫–æ—î–º—Ü—è—Ö

    async def close(self) -> None:
        """–ö–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–∑–∞–∫—Ä–∏—Ç–∏ —Ä–µ—Å—É—Ä—Å–∏)."""
        ...                                                                          # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —É —Å–ø–∞–¥–∫–æ—î–º—Ü—è—Ö

    async def update_all_rates_if_needed(self) -> None:                                # üîÅ –õ–µ–¥–∞—á–∏–π –∞–ø–¥–µ–π—Ç –∫—É—Ä—Å—ñ–≤
        """–õ–µ–¥–∞—á–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤: –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ª–∏—à–µ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    async def update_all_rates(self) -> None:                                          # üîÑ –ü—Ä–∏–º—É—Å–æ–≤–∏–π –∞–ø–¥–µ–π—Ç –∫—É—Ä—Å—ñ–≤
        """–ü—Ä–∏–º—É—Å–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫—É—Ä—Å—ñ–≤."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    async def set_rate_manually(
        self,
        currency: str,
        rate: Union[Decimal, float, int, str],
    ) -> None:                                                                         # ‚úçÔ∏è –†—É—á–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É—Ä—Å—É
        """–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫—É—Ä—Å –≤—Ä—É—á–Ω—É (–∞–¥–º—ñ–Ω—Å—å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π)."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    def get_money_converter(self) -> IMoneyConverter:                                  # üíµ –û—Ç—Ä–∏–º–∞—Ç–∏ Decimal-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
        """–û—Ç—Ä–∏–º–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π Decimal-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä (snapshot)."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    def get_converter(self) -> ICurrencyConverter:                                     # üï∞Ô∏è –û—Ç—Ä–∏–º–∞—Ç–∏ –ª–µ–≥–∞—Å—ñ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
        """–û—Ç—Ä–∏–º–∞—Ç–∏ –ª–µ–≥–∞—Å—ñ float-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä (snapshot)."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    def get_all_rates(self) -> Dict[str, Decimal]:                                     # üìä –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –∫—É—Ä—Å–∏
        """–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ–ø—ñ—é –º–∞–ø–∏ –∫—É—Ä—Å—ñ–≤ —É Decimal."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    @property
    def last_update_ts(self) -> float:                                                 # ‚è±Ô∏è Timestamp –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∞–ø–¥–µ–π—Ç—É
        """UNIX timestamp –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

    def is_cache_fresh(self) -> bool:                                                  # ‚ùÑÔ∏è –°—Ç–∞–Ω –∫–µ—à—É –∫—É—Ä—Å—ñ–≤
        """–ß–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –∫–µ—à –∫—É—Ä—Å—ñ–≤ (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø–æ–ª—ñ—Ç–∏–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)."""
        ...                                                                            # üßæ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ñ


# ================================
# üîì –ü–£–ë–õ–Ü–ß–ù–ò–ô API
# ================================
__all__ = [
    "CurrencyCode",                                                             # üî§ ISO-4217 –∞–ª—ñ–∞—Å
    "Money",                                                                    # üíµ DTO —Å—É–º–∏
    "CurrencyRateNotFoundError",                                                # üö´ –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –≤–∏–Ω—è—Ç–æ–∫
    "ICurrencyConverter",                                                       # üï∞Ô∏è –õ–µ–≥–∞—Å—ñ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
    "IMoneyConverter",                                                          # üíµ –û—Å–Ω–æ–≤–Ω–∏–π Decimal-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
    "ICurrencyRatesProvider",                                                   # üìà –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∫—É—Ä—Å—ñ–≤
]
logger.debug("üîì __all__ –æ–≥–æ–ª–æ—à–µ–Ω–æ: %s", __all__)                                # üßæ –ü—É–±–ª—ñ—á–Ω–∏–π API –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ
