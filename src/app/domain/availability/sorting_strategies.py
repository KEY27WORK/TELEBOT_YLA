# üß© app/domain/availability/sorting_strategies.py
"""
üß© sorting_strategies.py ‚Äî –∫–ª—é—á–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤.

–ù–∞–≤—ñ—â–æ –æ–∫—Ä–µ–º–∏–π –º–æ–¥—É–ª—å:
- –î–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —ñ–Ω º—î–∫—Ç—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤ –¥–æ–º–µ–Ω–Ω–∏–π —Å–µ—Ä–≤—ñ—Å.
- –¢–µ—Å—Ç—É–≤–∞—Ç–∏ —Ç–∞ —Ä–æ–∑–≤–∏–≤–∞—Ç–∏ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∏.

üîπ default_size_sort_key:
  1) –í—ñ–¥–æ–º—ñ –ª—ñ—Ç–µ—Ä–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ —É —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É (XXXS..XXXL)
  2) –ß–∏—Å–ª–æ–≤—ñ (–≤–∫–ª—é—á–Ω–æ –∑ –¥—Ä–æ–±–∞–º–∏ 42.5 / 42,5) ‚Äî –∑–∞ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è–º
  3) –£—Å–µ —ñ–Ω—à–µ ‚Äî –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ
"""

from __future__ import annotations

# üî† –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                                                 # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
from typing import Callable, Tuple                                             # üß∞ –¢–∏–ø–∏ –¥–ª—è –∫–ª—é—á–∞

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ
from app.shared.utils.logger import LOG_NAME                                   # üè∑Ô∏è –ü—Ä–µ—Ñ—ñ–∫—Å –ª–æ–≥–µ—Ä–∞


# ================================
# üßæ –õ–û–ì–ï–† –ú–û–î–£–õ–Ø
# ================================
MODULE_LOGGER_NAME: str = f"{LOG_NAME}.domain.availability.sorting"           # üè∑Ô∏è –ü—Ä–µ—Ñ—ñ–∫—Å –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
logger = logging.getLogger(MODULE_LOGGER_NAME)                                 # üßæ –ú–æ–¥—É–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä
logger.debug("üß© sorting_strategies —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ")                               # üöÄ –§—ñ–∫—Å—É—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é


# –¢–∏–ø –∫–ª—é—á–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è (–≤–∞–∂–ª–∏–≤–æ, —â–æ–± –∫–æ—Ä—Ç–µ–∂—ñ –º–æ–∂–Ω–∞ –±—É–ª–æ –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ –º—ñ–∂ —Å–æ–±–æ—é)
SizeKey = Callable[[str], Tuple[int, int, str]]                                # üßÆ Callable –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤

# –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –ª—ñ—Ç–µ—Ä–Ω–∏—Ö —Ä–æ–∑–º—ñ—Ä—ñ–≤
_KNOWN_ALPHA: Tuple[str, ...] = (
    "XXXS",
    "XXS",
    "XS",
    "S",
    "M",
    "L",
    "XL",
    "XXL",
    "XXXL",
)                                                                             # üìã –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º-—Ñ–∞–∫—Ç–æ—Ä—ñ–≤


def _normalize(size: str) -> str:
    """–¢—Ä–∏–º + upper –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ –ø–æ—Ä—ñ–≤–Ω—è–Ω—å."""

    normalized: str = (size or "").strip().upper()                           # ‚úÇÔ∏è –¢—Ä–∏–º + upper
    logger.debug("üîß _normalize | raw=%r normalized=%r", size, normalized)    # üßæ –¢—Ä–∞—Å—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—é
    return normalized                                                         # üì§ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è


def default_size_sort_key(size: str) -> Tuple[int, int, str]:
    """
    –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –∫–ª—é—á —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:
      0) –≤—ñ–¥–æ–º—ñ –ª—ñ—Ç–µ—Ä–Ω—ñ ‚Üí (0, index, "")
      1) —á–∏—Å–ª–æ–≤—ñ (—É —Ç.—á. '42.5' / '42,5') ‚Üí (1, int(num*100), "")
      2) —ñ–Ω—à–µ ‚Üí (2, 0, lexicographic)
    """

    normalized_size: str = _normalize(size)                                   # üîÅ –ü–æ–ø–µ—Ä–µ–¥–Ω—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
    logger.debug("üìè default_size_sort_key –æ—Ç—Ä–∏–º–∞–≤=%r", normalized_size)       # üßæ –§—ñ–∫—Å—É—î–º–æ –≤–∏–∫–ª–∏–∫

    if normalized_size in _KNOWN_ALPHA:                                       # 1Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª—ñ—Ç–µ—Ä–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
        index: int = _KNOWN_ALPHA.index(normalized_size)                      # üî¢ –ü–æ–∑–∏—Ü—ñ—è –≤ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ–º—É —Å–ø–∏—Å–∫—É
        result_alpha: Tuple[int, int, str] = (0, index, "")                  # üßÆ –ö–æ—Ä—Ç–µ–∂ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        logger.debug("üî§ –õ—ñ—Ç–µ—Ä–Ω–∏–π —Ä–æ–∑–º—ñ—Ä | size=%r key=%s", normalized_size, result_alpha)
        return result_alpha                                                   # üì§ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–ª—é—á

    try:
        numeric_value: float = float(normalized_size.replace(",", "."))    # üî¢ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ 42,5 ‚Üí 42.5
        numeric_key: int = int(round(numeric_value * 100))                    # üßÆ –§—ñ–∫—Å—É—î–º–æ –¥–≤–∞ –∑–Ω–∞–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç—ñ
        result_numeric: Tuple[int, int, str] = (1, numeric_key, "")          # üßÆ –ö–æ—Ä—Ç–µ–∂ –¥–ª—è —á–∏—Å–ª–æ–≤–∏—Ö —Ä–æ–∑–º—ñ—Ä—ñ–≤
        logger.debug(
            "üî¢ –ß–∏—Å–ª–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä | size=%r value=%s key=%s",
            normalized_size,
            numeric_value,
            result_numeric,
        )                                                                    # üßæ –§—ñ–∫—Å—É—î–º–æ —á–∏—Å–ª–æ–≤—É –≥—ñ–ª–∫—É
        return result_numeric                                                 # üì§ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–ª—é—á
    except ValueError:
        logger.debug("üî∏ –ù–µ—á–∏—Å–ª–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä | size=%r", normalized_size)       # ‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∫–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ —É —á–∏—Å–ª–æ

    result_fallback: Tuple[int, int, str] = (2, 0, normalized_size)           # üì¶ –§–æ–ª–±–µ–∫ ‚Äî –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ—ñ—è
    logger.debug("üîπ Fallback —Ä–æ–∑–º—ñ—Ä | size=%r key=%s", normalized_size, result_fallback)
    return result_fallback                                                    # üì§ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–ª—é—á


__all__ = [
    "SizeKey",                                                                  # üßÆ –¢–∏–ø Callable –¥–ª—è –∫–ª—é—á—ñ–≤
    "default_size_sort_key",                                                    # üìè –ë–∞–∑–æ–≤–∏–π –∫–ª—é—á —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
]
logger.debug("üîì __all__ –æ–≥–æ–ª–æ—à–µ–Ω–æ: %s", __all__)                               # üßæ –ü—É–±–ª—ñ—á–Ω–∏–π API –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ
