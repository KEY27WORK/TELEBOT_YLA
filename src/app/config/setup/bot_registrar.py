# üßæ app/config/setup/bot_registrar.py
"""
üßæ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä Telegram-—Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤.

üîπ –î–µ–ª–µ–≥—É—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ–º–∞–Ω–¥ –æ–∫—Ä–µ–º–∏–º ¬´—Ñ—ñ—á–∞–º¬ª –∑ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
üîπ –ù–∞–ª–∞—à—Ç–æ–≤—É—î –≥–ª–æ–±–∞–ª—å–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –º–µ–Ω—é, callback-—ñ–≤ —ñ –ø–æ—Å–∏–ª–∞–Ω—å —ñ–∑ –∑–∞—Ö–∏—Å—Ç–æ–º –≤—ñ–¥ –ø–æ–º–∏–ª–æ–∫
üîπ –ó–∞–±–µ–∑–ø–µ—á—É—î –∑–≤–æ—Ä–æ—Ç–Ω—É —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —ñ–∑ legacy-API (`menu_handler`)
"""

from __future__ import annotations

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from telegram.ext import Application, CallbackQueryHandler, MessageHandler, filters  # ü§ñ Telegram API

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                                                      # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
from typing import TYPE_CHECKING, Any, Callable, Optional                           # üßÆ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.config.setup import constants as const                                     # üìñ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ UI/–ª–æ–≥—ñ–∫–∏
from app.shared.utils.logger import LOG_NAME                                        # üè∑Ô∏è –Ü–º'—è –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –ª–æ–≥–µ—Ä–∞

if TYPE_CHECKING:                                                                   # üß™ –õ–∏—à–µ –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫ —Ç–∏–ø—ñ–≤
    from app.config.setup.container import Container                                # üì¶ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏

# ================================
# üßæ –õ–û–ì–ï–† –ú–û–î–£–õ–Ø
# ================================
logger = logging.getLogger(LOG_NAME)                                                # üßæ –ú–æ–¥—É–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä


# ================================
# üèõÔ∏è –ö–õ–ê–° –†–ï–Ñ–°–¢–†–ê–¢–û–†–ê
# ================================
class BotRegistrar:
    """
    –ö–æ–æ—Ä–¥–∏–Ω—É—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—Å—ñ—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –¥–æ `telegram.ext.Application`.
    """

    # ================================
    # ‚öôÔ∏è –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    # ================================
    def __init__(self, application: Application, container: "Container") -> None:
        """
        –ó–±–µ—Ä—ñ–≥–∞—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Ç–∞ –≥–æ—Ç—É—î –æ–±–≥–æ—Ä—Ç–∫—É –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫.
        """
        self.app = application                                                       # ü§ñ –Ü–Ω—Å—Ç–∞–Ω—Å Telegram Application
        self.container = container                                                   # üì¶ –î–∂–µ—Ä–µ–ª–æ —Å–µ—Ä–≤—ñ—Å—ñ–≤ —Ç–∞ —Ñ—ñ—á
        self.error_handler: Callable[[Callable[..., Any]], Callable[..., Any]] = (
            container.error_handler
        )                                                                            # üõ°Ô∏è –û–±–≥–æ—Ä—Ç–∫–∞ (handler -> safe handler)
        logger.debug("üßæ BotRegistrar —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ (app=%s)", type(application).__name__)  # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó

    # ================================
    # üîó –ü–£–ë–õ–Ü–ß–ù–ò–ô –Ü–ù–¢–ï–†–§–ï–ô–°
    # ================================
    def register_handlers(self) -> None:
        """
        –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–æ —Ä–µ—î—Å—Ç—Ä—É—î —Ñ—ñ—á—ñ —Ç–∞ –≥–ª–æ–±–∞–ª—å–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏.
        """
        logger.info("üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤—Å—ñ—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤")   # üßæ –°—Ç–∞—Ä—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        self._register_features()                                        # ‚ú® –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Ñ—ñ—á—ñ
        self._register_global_handlers()                                 # üåê –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        logger.info("‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤—Å—ñ—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")           # üßæ –§—ñ–∫—Å—É—î–º–æ —É—Å–ø—ñ—Ö

    # ================================
    # ‚ú® –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø –§–Ü–ß
    # ================================
    def _register_features(self) -> None:
        """
        –ü–µ—Ä–µ–¥–∞—î `Application` —É –∫–æ–∂–Ω—É —Ñ—ñ—á—É, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î –º–µ—Ç–æ–¥ `register_handlers`.
        """
        features = getattr(self.container, "features", [])               # üì¶ –°–ø–∏—Å–æ–∫ —Ñ—ñ—á —ñ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        logger.info("üß© –ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ %d —Ñ—ñ—á –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó", len(features))  # üßæ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–±—Å—è–≥ —Ä–æ–±–æ—Ç–∏

        for feature in features:                                         # üîÅ –û–±—Ö–æ–¥–∏–º–æ –≤—Å—ñ —Ñ—ñ—á—ñ
            feature_name = feature.__class__.__name__                    # üè∑Ô∏è –ù–∞–∑–≤–∞ –¥–ª—è –ª–æ–≥—ñ–≤
            register_fn = getattr(feature, "register_handlers", None)    # üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –º–µ—Ç–æ–¥—É
            if callable(register_fn):                                    # ‚úÖ –§—ñ—á–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
                logger.debug("üß© –§—ñ—á–∞ %s –ø–æ—á–∞–ª–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é", feature_name)  # üßæ –°—Ç–∞—Ä—Ç —Ñ—ñ—á—ñ
                register_fn(self.app)                                    # üì• –î–µ–ª–µ–≥—É—î–º–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤ Application
                logger.info("‚úÖ –§—ñ—á–∞ %s –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ", feature_name)  # üßæ –£—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            else:                                                        # üö´ –†–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –Ω—ñ—á–æ–≥–æ
                logger.warning("‚ö†Ô∏è –§—ñ—á–∞ %s –Ω–µ –º–∞—î register_handlers()", feature_name)  # üßæ –ü–æ—è—Å–Ω–µ–Ω–Ω—è –ø—Ä–æ–ø—É—Å–∫—É

    # ================================
    # üåê –ì–õ–û–ë–ê–õ–¨–ù–Ü –û–ë–†–û–ë–ù–ò–ö–ò
    # ================================
    def _register_global_handlers(self) -> None:
        """
        –†–µ—î—Å—Ç—Ä—É—î callback-–∏, –º–µ–Ω—é —Ç–∞ –æ–±—Ä–æ–±–Ω–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ—Å–∏–ª–∞–Ω—å.
        """
        logger.info("üåê –ü–æ—á–∏–Ω–∞—é —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤")       # üßæ –°—Ç–∞—Ä—Ç —Å–µ–∫—Ü—ñ—ó

        callback_handler = self.container.callback_handler.handle        # üîÅ –ë–∞–∑–æ–≤–∏–π callback-entry
        self.app.add_handler(                                            # ‚ûï –†–µ—î—Å—Ç—Ä—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π CallbackQueryHandler
            CallbackQueryHandler(self.error_handler(callback_handler))
        )
        logger.info("‚úÖ CallbackQueryHandler –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ")              # üßæ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó

        menu_pattern = const.generate_menu_pattern()                     # üßµ –†–µ–≥–µ–∫—Å –¥–ª—è –º–µ–Ω—é (legacy + –Ω–æ–≤—ñ –∫–Ω–æ–ø–∫–∏)
        logger.debug("üßµ –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø–∞—Ç–µ—Ä–Ω –º–µ–Ω—é: %s", menu_pattern)     # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞—Ç–µ—Ä–Ω—É
        menu_handler = self._resolve_menu_handler()                      # üß≠ –®—É–∫–∞—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ö–µ–Ω–¥–ª–µ—Ä –º–µ–Ω—é
        if menu_handler is not None:                                     # ‚úÖ –ú–µ–Ω—é –¥–æ—Å—Ç—É–ø–Ω–µ
            self.app.add_handler(                                        # ‚ûï –†–µ—î—Å—Ç—Ä—É—î–º–æ Reply-–º–µ–Ω—é
                MessageHandler(filters.TEXT & filters.Regex(menu_pattern), self.error_handler(menu_handler))
            )
            logger.info("‚úÖ –ì–ª–∞–≤–Ω–µ –º–µ–Ω—é –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ")          # üßæ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
        else:                                                            # üö´ –ú–µ–Ω—é –≤—ñ–¥—Å—É—Ç–Ω—î
            logger.warning(
                "‚ö†Ô∏è –ú–µ–Ω—é –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ: main_menu_feature/menu_handler –≤—ñ–¥—Å—É—Ç–Ω—ñ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ"
            )                                                            # üßæ –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è

        link_handler = self.container.link_handler.handle_link           # üîó –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è URL/–ø–æ—à—É–∫—É
        self.app.add_handler(                                            # ‚ûï –†–µ—î—Å—Ç—Ä—É—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–±—Ä–æ–±–Ω–∏–∫
            MessageHandler(
                filters.TEXT & ~filters.COMMAND & ~filters.Regex(menu_pattern),
                self.error_handler(link_handler),
            )
        )
        logger.info("‚úÖ –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ—Å–∏–ª–∞–Ω—å/–∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ")  # üßæ –ü—ñ–¥—Å—É–º–æ–∫ –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤

    # ================================
    # üß≠ –î–û–ü–û–ú–Ü–ñ–ù–Ü –ú–ï–¢–û–î–ò
    # ================================
    def _resolve_menu_handler(self) -> Optional[Callable[..., Any]]:
        """
        –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –∞–±–æ legacy-API –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –º–µ–Ω—é.
        """
        feature = getattr(self.container, "main_menu_feature", None)     # üÜï –ù–æ–≤–∏–π —Å—Ç–∏–ª—å –∑ handle_menu
        if feature and hasattr(feature, "handle_menu"):                  # ‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤–∏–π API
            logger.debug("üß≠ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é main_menu_feature.handle_menu")  # üßæ –í–∫–∞–∑—É—î–º–æ, —è–∫–∏–π —à–ª—è—Ö –æ–±—Ä–∞–Ω–æ
            return feature.handle_menu                                   # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–µ—Ç–æ–¥

        legacy = getattr(self.container, "menu_handler", None)           # ‚ôªÔ∏è Legacy –∞–ª—ñ–∞—Å
        if legacy and hasattr(legacy, "handle_menu"):                    # ‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ legacy API
            logger.debug("‚ôªÔ∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é legacy menu_handler.handle_menu")  # üßæ –ü–æ—è—Å–Ω–µ–Ω–Ω—è –≤–∏–±–æ—Ä—É
            return legacy.handle_menu                                    # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥

        logger.debug("üö´ –•–µ–Ω–¥–ª–µ—Ä –º–µ–Ω—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ")        # üßæ –Ü–Ω—Ñ–æ—Ä–º—É—î–º–æ –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å
        return None                                                      # ‚õî –ú–µ–Ω—é –Ω–µ —Ä–µ—î—Å—Ç—Ä—É—î–º–æ
