# ‚öôÔ∏è app/config/config_service.py
"""
‚öôÔ∏è –°–µ—Ä–≤—ñ—Å –¥–æ—Å—Ç—É–ø—É –¥–æ —Å—Ç–∞—Ç–∏—á–Ω–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó.

üîπ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î .env —Ç–∞ YAML-—Ñ–∞–π–ª–∏, –∑–ª–∏–≤–∞—é—á–∏ —ó—Ö —É —Å–ø—ñ–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫
üîπ –ü—ñ–¥—Ç—Ä–∏–º—É—î —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—é –ø–æ—Å–∏–ª–∞–Ω—å ${VAR} / ${VAR:-default} —É YAML
üîπ –ù–∞–¥–∞—î Singleton-API –∑ –º–µ—Ç–æ–¥–æ–º `.get()` —ñ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é hot-reload
"""

from __future__ import annotations

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
import yaml                                                             # üìò –†–æ–∑–±—ñ—Ä YAML-—Ñ–∞–π–ª—ñ–≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
from dotenv import load_dotenv                                          # üå± –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è .env-–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                                          # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –∫—Ä–æ–∫—ñ–≤ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è
import os                                                               # üåê –î–æ—Å—Ç—É–ø –¥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö
import re                                                               # üßµ –Ü–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—è —à–∞–±–ª–æ–Ω—ñ–≤ ${VAR}
from pathlib import Path                                                # üìÇ –†–æ–±–æ—Ç–∞ –∑ —Ñ–∞–π–ª–æ–≤–∏–º–∏ —à–ª—è—Ö–∞–º–∏
from typing import Any, Callable, Dict, Match, Optional, TypeVar        # üßÆ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è —Ç–∞ generic-–∏

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.config.setup.constants import CONST                            # üìñ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ (ENV_PREFIX, —Ç–æ—â–æ)
from app.shared.utils.logger import LOG_NAME                            # üè∑Ô∏è –Ü–º'—è –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –ª–æ–≥–µ—Ä–∞

T = TypeVar("T")                                                        # üîÅ –£–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∏–π —Ç–∏–ø –¥–ª—è `.get()`

# ================================
# üßæ –ö–û–ù–°–¢–ê–ù–¢–ò –ú–û–î–£–õ–Ø
# ================================
_ENV_REF_RE = re.compile(r"\$\{([A-Z0-9_]+)(?::-(.*?))?\}")             # üßµ –ü–∞—Ç–µ—Ä–Ω ${VAR} —Ç–∞ ${VAR:-default}
_YAML_DIR = Path(__file__).parent / "yamls"                             # üìÇ –ë–∞–∑–æ–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è YAML-—Ñ–∞–π–ª—ñ–≤
logger = logging.getLogger(LOG_NAME)                                    # üßæ –ú–æ–¥—É–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä


# ================================
# üèõÔ∏è –°–ï–†–í–Ü–° –î–û–°–¢–£–ü–£ –î–û –ö–û–ù–§–Ü–ì–Ü–í
# ================================
class ConfigService:
    """
    –Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å—Ç–∞—Ç–∏—á–Ω–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó (Singleton).
    """

    _instance: Optional["ConfigService"] = None                          # üß± –ó–±–µ—Ä–µ–∂–µ–Ω–∏–π Singleton-–µ–∫–∑–µ–º–ø–ª—è—Ä
    _config: Dict[str, Any] = {}                                         # üì¶ –û–±'—î–¥–Ω–∞–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫ –∫–æ–Ω—Ñ—ñ–≥—ñ–≤
    logger: logging.Logger                                               # üßæ –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä —ñ–Ω—Å—Ç–∞–Ω—Å—É

    # ================================
    # ‚öôÔ∏è –ñ–ò–¢–¢–Ñ–í–ò–ô –¶–ò–ö–õ
    # ================================
    def __new__(cls) -> "ConfigService":
        """
        –ì–∞—Ä–∞–Ω—Ç—É—î —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ —ñ –≤–∏–∫–æ–Ω—É—î –ø–µ—Ä–≤–∏–Ω–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
        """
        if cls._instance is None:                                        # üÜï –©–µ –Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞–ª–∏
            logger.debug("üÜï –°—Ç–≤–æ—Ä—é—é ConfigService Singleton")           # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
            cls._instance = super().__new__(cls)                         # üèóÔ∏è –í–∏–¥—ñ–ª—è—î–º–æ —ñ–Ω—Å—Ç–∞–Ω—Å
            cls._instance.logger = logging.getLogger(LOG_NAME)           # üßæ –û–∫—Ä–µ–º–∏–π –ª–æ–≥–µ—Ä –¥–ª—è –º–µ—Ç–æ–¥—É
            cls._instance.reload()                                       # üîÑ –ü–µ—Ä–≤–∏–Ω–Ω–µ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –∫–æ–Ω—Ñ—ñ–≥—ñ–≤
        return cls._instance                                             # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≥–æ—Ç–æ–≤–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å

    # ================================
    # üîÑ –ö–ï–†–£–í–ê–ù–ù–Ø –°–¢–ê–ù–û–ú
    # ================================
    def reload(self) -> None:
        """
        –ü–µ—Ä–µ—á–∏—Ç—É—î .env —ñ YAML-—Ñ–∞–π–ª–∏ (–∑—Ä—É—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—ñ–≤ —Ç–∞ hot-reload).
        """
        self.logger.info("üîÑ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó...")          # üßæ –ü–æ—á–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ—ó reload
        self._load_all_configs()                                         # üì• –°—Ç–∞—Ä—Ç –∫–æ–Ω–≤–µ—î—Ä–∞ —á–∏—Ç–∞–Ω–Ω—è

    # ================================
    # üì• –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–á
    # ================================
    def _load_all_configs(self) -> None:
        """
        –û—Ä–∫–µ—Å—Ç—Ä—É—î –∑–ª–∏—Ç—Ç—è .env + YAML —É —Å–ø—ñ–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫.
        """
        self._config = {}                                                # üßπ –°–∫–∏–¥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–µ—à
        self.logger.debug("üßπ –û—á–∏—Å—Ç–∏–≤ –∫–µ—à –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥ –∑–ª–∏—Ç—Ç—è–º")   # üßæ –§—ñ–∫—Å—É—î–º–æ —Å–∫–∏–¥–∞–Ω–Ω—è
        self._load_from_env()                                            # 1Ô∏è‚É£ .env ‚Üí nested —Å–ª–æ–≤–Ω–∏–∫
        self._load_from_yaml_files()                                     # 2Ô∏è‚É£ YAML ‚Üí deep merge
        self.logger.info("‚úÖ –ö–æ–Ω—Ñ—ñ–≥ —É—Å–ø—ñ—à–Ω–æ –∑—ñ–±—Ä–∞–Ω–æ –∑ ENV —Ç–∞ YAML")      # üßæ –£—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è

    def _load_from_env(self) -> None:
        """
        –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î APP_* –∑–º—ñ–Ω–Ω—ñ –∑ .env/ENV —Ç–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö —É –≤–∫–ª–∞–¥–µ–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫.
        """
        load_dotenv()                                                     # üå± –ü—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ .env —É os.environ
        env_vars: Dict[str, Any] = {}                                     # üßÆ –ë—É—Ñ–µ—Ä –¥–ª—è –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö –∫–ª—é—á—ñ–≤
        prefix: str = getattr(CONST.LOGIC, "ENV_PREFIX", "APP_")          # üè∑Ô∏è –û—á—ñ–∫—É–≤–∞–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å

        for key, value in os.environ.items():                             # üîÅ –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –ø–µ—Ä–µ–º—ñ–Ω–Ω—ñ
            if not key.startswith(prefix):                                # üö´ –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —á—É–∂—ñ –∫–ª—é—á—ñ
                continue                                                  # ‚Ü©Ô∏è –î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó
            normalized = key[len(prefix):].lower().replace("_", ".")      # ‚úÇÔ∏è –†–æ–±–∏–º–æ –∫–ª—é—á of format a.b.c
            env_vars[normalized] = value                                  # üì• –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —É –±—É—Ñ–µ—Ä
            self.logger.debug("üå± ENV %s -> %s", key, normalized)         # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç—É—î–º–æ –º–∞–ø—ñ–Ω–≥

        nested_env = self._unflatten_dict(env_vars)                       # ü™Ü –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —É –≤–∫–ª–∞–¥–µ–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        self._deep_update(self._config, nested_env)                       # ‚ôªÔ∏è –ú–µ—Ä–¥–∂–∏–º–æ –∑ –æ—Å–Ω–æ–≤–Ω–∏–º —Å–ª–æ–≤–Ω–∏–∫–æ–º
        self.logger.info("üå± –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ %d ENV-–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤", len(env_vars))  # üßæ –ü—ñ–¥—Å—É–º–æ–∫ –æ–±—Å—è–≥—É ENV

    def _load_from_yaml_files(self) -> None:
        """
        –î–æ–¥–∞—î –¥–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –≤—Å—ñ YAML-—Ñ–∞–π–ª–∏ –∑ `config/setup/yamls`.
        """
        yaml_files = sorted(_YAML_DIR.rglob("*.yaml"))                    # üìÇ –†–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π –ø–æ—à—É–∫
        self.logger.info("üìö –ó–Ω–∞–π–¥–µ–Ω–æ %d YAML-—Ñ–∞–π–ª—ñ–≤", len(yaml_files))   # üßæ –ü—ñ–¥—Å—É–º–∫–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

        for yaml_path in yaml_files:                                      # üîÅ –ü—Ä–æ—Ö–æ–¥–∏–º–æ –∫–æ–∂–µ–Ω —Ñ–∞–π–ª
            relative = yaml_path.relative_to(_YAML_DIR)                   # üìé –í—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–ª—è –ª–æ–≥—ñ–≤
            try:
                self.logger.debug("üìò –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é YAML: %s", relative)     # üßæ –ü–æ—á–∞—Ç–æ–∫ —á–∏—Ç–∞–Ω–Ω—è
                with open(yaml_path, "r", encoding="utf-8") as stream:    # üìÇ –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª
                    raw = yaml.safe_load(stream) or {}                    # üßæ –î–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î–º–æ –≤–º—ñ—Å—Ç
                interpolated = self._interpolate_env(raw)                 # üîÅ –ü—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ ${VAR}
                self._deep_update(self._config, interpolated)             # ‚ôªÔ∏è –û–±'—î–¥–Ω—É—î–º–æ –∑ –ø–æ—Ç–æ—á–Ω–∏–º —Å—Ç–∞–Ω–æ–º
                self.logger.debug("‚úÖ YAML %s –∑–ª–∏—Ç–∏–π —É –∫–æ–Ω—Ñ—ñ–≥", relative) # üßæ –£—Å–ø—ñ—à–Ω–µ –∑–ª–∏—Ç—Ç—è
            except (FileNotFoundError, yaml.YAMLError) as exc:           # ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∏ —á–∏—Ç–∞–Ω–Ω—è
                self.logger.warning("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ %s —á–µ—Ä–µ–∑ %s", relative, exc)  # üßæ –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è

    # ================================
    # üîë –î–û–°–¢–£–ü –î–û –ó–ù–ê–ß–ï–ù–¨
    # ================================
    def get(
        self,
        key: str,
        default: Optional[T] = None,
        cast: Optional[Callable[[Any], T]] = None,
    ) -> Optional[T]:
        """
        –ü–æ–≤–µ—Ä—Ç–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∫—Ä–∞–ø–∫–æ–≤–∏–º –∫–ª—é—á–µ–º —ñ–∑ –º–æ–∂–ª–∏–≤–∏–º –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è–º —Ç–∏–ø—É.
        """
        node: Any = self._config                                          # üß± –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –≤—É–∑–æ–ª –¥–µ—Ä–µ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—ñ–≤
        for part in key.split("."):                                      # üîÅ –ö—Ä–æ–∫—É—î–º–æ —à–ª—è—Ö–æ–º a.b.c
            if isinstance(node, dict) and part in node:                  # ‚úÖ –í—É–∑–æ–ª —ñ—Å–Ω—É—î
                node = node[part]                                        # üì¶ –°–ø—É—Å–∫–∞—î–º–æ—Å—è –≥–ª–∏–±—à–µ
                self.logger.debug("üîç –ö—Ä–æ–∫ get('%s'): –∑–Ω–∞–π–¥–µ–Ω–æ –≤—É–∑–æ–ª '%s'", key, part)  # üßæ –õ–æ–∫–∞–ª—å–Ω–∏–π –∫—Ä–æ–∫
            else:                                                        # üö´ –ö–ª—é—á –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
                self.logger.debug("üîç get('%s'): –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –≤—É–∑–æ–ª '%s'", key, part)      # üßæ –§—ñ–∫—Å—É—î–º–æ –ø—Ä–æ–º–∞—Ö
                return default                                           # ‚Ü©Ô∏è –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç

        if cast is not None and node is not None:                        # ‚úÖ –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–∏–ø
            try:
                casted = cast(node)                                      # üßÆ –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –∫–∞—Å—Ç
                self.logger.debug("üßÆ get('%s'): –ø—Ä–∏–≤—ñ–≤ –¥–æ %s", key, cast.__name__)  # üßæ –£—Å–ø—ñ—Ö –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è
                return casted                                            # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            except (TypeError, ValueError):                              # ‚ö†Ô∏è –•–∏–±–Ω–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è
                self.logger.warning(
                    "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫–ª—é—á '%s' –∑—ñ –∑–Ω–∞—á–µ–Ω–Ω—è–º %r –¥–æ %s. –ü–æ–≤–µ—Ä—Ç–∞—é default.",
                    key,
                    node,
                    getattr(cast, "__name__", str(cast)),
                )
                return default                                           # ‚Ü©Ô∏è –í—ñ–¥–¥–∞—î–º–æ –¥–µ—Ñ–æ–ª—Ç

        return node                                                      # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–Ω–∞–π–¥–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –±–µ–∑ cast

    # ================================
    # üß∞ –î–û–ü–û–ú–Ü–ñ–ù–Ü –ú–ï–¢–û–î–ò
    # ================================
    def _unflatten_dict(self, flat: Dict[str, Any]) -> Dict[str, Any]:
        """
        –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î –∫–ª—é—á—ñ –≤–∏–¥—É 'a.b.c' —É –≤–∫–ª–∞–¥–µ–Ω—ñ —Å–ª–æ–≤–Ω–∏–∫–∏.
        """
        result: Dict[str, Any] = {}                                      # üì¶ –ü–æ—Ä–æ–∂–Ω—ñ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        for dotted_key, value in flat.items():                           # üîÅ –û–±—Ä–æ–±–ª—è—î–º–æ –≤—Å—ñ –∫–ª—é—á—ñ
            if value is None:                                            # üö´ –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ None
                continue                                                 # ‚Ü©Ô∏è
            parts = dotted_key.split(".")                                # ‚úÇÔ∏è –†–æ–∑–±–∏–≤–∞—î–º–æ —à–ª—è—Ö
            cursor = result                                              # üß≠ –í–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å
            for segment in parts[:-1]:                                   # üîÅ –ö—Ä–æ–∫—É—î–º–æ –¥–æ –ø–µ—Ä–µ–¥–æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ
                cursor = cursor.setdefault(segment, {})                  # ü™Ü –°—Ç–≤–æ—Ä—é—î–º–æ –≤–∫–ª–∞–¥–µ–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫
            cursor[parts[-1]] = value                                    # üì• –ó–∞–ø–∏—Å—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
            self.logger.debug("ü™Ü –†–æ–∑–≥–æ—Ä–Ω—É–≤ –∫–ª—é—á %s", dotted_key)        # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return result                                                    # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤–∫–ª–∞–¥–µ–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫

    def _deep_update(self, target: Dict[str, Any], source: Dict[str, Any]) -> None:
        """
        –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∑–ª–∏–≤–∞—î `source` —É `target`.
        """
        for key, value in source.items():                                # üîÅ –û–±—Ö–æ–¥–∏–º–æ –≤—Å—ñ –ø–∞—Ä–∏
            if isinstance(value, dict) and isinstance(target.get(key), dict):  # üß¨ –û–±–∏–¥–≤—ñ –≥—ñ–ª–∫–∏ —Å–ª–æ–≤–Ω–∏–∫–∏
                self._deep_update(target[key], value)                    # ‚ôªÔ∏è –†–µ–∫—É—Ä—Å–∏–≤–Ω–µ –∑–ª–∏—Ç—Ç—è
            else:                                                        # üì¶ –ü—Ä—è–º–∏–π –∑–∞–ø–∏—Å
                target[key] = value                                      # üìù –ü–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è
            self.logger.debug("üß± Deep update –∫–ª—é—á–∞ %s", key)            # üßæ –§—ñ–∫—Å—É—î–º–æ –∑–º—ñ–Ω—É

    def _interpolate_env(self, node: Any) -> Any:
        """
        –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î –∑–Ω–∞—á–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —É —Ä—è–¥–∫–∏.
        """
        if isinstance(node, dict):                                       # üß± –°–ª–æ–≤–Ω–∏–∫ ‚Üí –æ–±—Ö–æ–¥–∏–º–æ –¥–æ—á—ñ—Ä–Ω—ñ –≥—ñ–ª–∫–∏
            return {k: self._interpolate_env(v) for k, v in node.items()}  # üîÅ –û–±—Ä–æ–±–∫–∞ –ø–∞—Ä –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–Ω—è
        if isinstance(node, list):                                       # üìã –°–ø–∏—Å–æ–∫ ‚Üí –æ–±—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏
            return [self._interpolate_env(item) for item in node]        # üîÅ –†–µ–∫—É—Ä—Å—ñ—è –ø–æ –µ–ª–µ–º–µ–Ω—Ç–∞—Ö
        if isinstance(node, str):                                        # üßµ –†—è–¥–æ–∫ ‚Üí —à—É–∫–∞—î–º–æ –ø–∞—Ç–µ—Ä–Ω–∏
            interpolated = _ENV_REF_RE.sub(self._env_replace, node)      # ‚úÇÔ∏è –ü—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω—å
            if interpolated != node:                                     # ‚úÖ –í–∏—è–≤–ª–µ–Ω–æ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫—É
                self.logger.debug("üîÅ –Ü–Ω—Ç–µ—Ä–ø–æ–ª—é–≤–∞–≤ '%s' -> '%s'", node, interpolated)  # üßæ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            return interpolated                                          # üîÅ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return node                                                      # üîÅ –î–ª—è —ñ–Ω—à–∏—Ö —Ç–∏–ø—ñ–≤ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —è–∫ —î

    @staticmethod
    def _env_replace(match: Match[str]) -> str:
        """
        –û–±—Ä–æ–±–ª—è—î –∑–±—ñ–≥ ${VAR} / ${VAR:-default}.
        """
        var_name = match.group(1)                                        # üè∑Ô∏è –ù–∞–∑–≤–∞ –∑–º—ñ–Ω–Ω–æ—ó
        fallback = match.group(2)                                        # üßØ –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        value = os.environ.get(var_name, fallback or "")                 # üì¶ –ó—á–∏—Ç—É—î–º–æ —Ñ–∞–∫—Ç–∏—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
        logger.debug("üåê –ü—ñ–¥—Å—Ç–∞–≤–ª—è—é ENV %s -> %r", var_name, value)      # üßæ –õ–æ–≥ —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—ó
        return value                                                     # üîÅ –†—è–¥–æ–∫, —è–∫–∏–π –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î–º–æ


# ================================
# üì¶ –ü–£–ë–õ–Ü–ß–ù–ò–ô API –ú–û–î–£–õ–Ø
# ================================
__all__ = ["ConfigService"]                                             # üì¶ –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å
