# üìà app/shared/metrics/exporters.py
# -*- coding: utf-8 -*-
"""
üìà –õ–µ–≥–∫–∏–π bootstrap Prometheus-–µ–∫—Å–ø–æ—Ä—Ç–µ—Ä—É (`/metrics` endpoint).

üîπ –°—Ç–∞—Ä—Ç—É—î HTTP-—Å–µ—Ä–≤–µ—Ä –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—É.
üîπ –ü—Ä–æ–ø—É—Å–∫–∞—î –∑–∞–ø—É—Å–∫, —è–∫—â–æ –ø–æ—Ä—Ç –Ω–µ –∑–∞–¥–∞–Ω–æ –∞–±–æ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –ø—ñ–¥–Ω—è—Ç–æ.
üîπ –ü–∏—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç—É –∞–±–æ –ø–æ–º–∏–ª–æ–∫.
"""

from __future__ import annotations

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                         # ü™µ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –∑–∞–ø—É—Å–∫—É
from typing import Optional                           # üß∞ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from prometheus_client import start_http_server        # üß© HTTP-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É –º–µ—Ç—Ä–∏–∫

# ================================
# üßæ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ú–û–î–£–õ–Ø
# ================================
log = logging.getLogger(__name__)                     # üßæ –õ–æ–∫–∞–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä –º–æ–¥—É–ª—è
_started = False                                      # üèÅ –§–ª–∞–≥ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç—É


# ================================
# üöÄ –ó–ê–ü–£–°–ö –ü–†–û–ú–ï–¢–ï–£–° –ï–ö–°–ü–û–†–¢–ï–†–ê
# ================================
def maybe_start_prometheus(port: Optional[int]) -> None:
    """–°—Ç–∞—Ä—Ç—É—î `/metrics` —Å–µ—Ä–≤–µ—Ä, —è–∫—â–æ –ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π —ñ —Å–µ—Ä–≤—ñ—Å —â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ."""
    global _started                                    # üîÅ –ó–º—ñ–Ω—é—î–º–æ –º–æ–¥—É–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
    if _started:                                       # ‚õî –í–∂–µ –∑–∞–ø—É—â–µ–Ω–æ
        return
    if not port:                                       # ‚ö†Ô∏è –ü–æ—Ä—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ
        return
    try:
        start_http_server(int(port))                   # üåê –ó–∞–ø—É—Å–∫–∞—î–º–æ Prometheus HTTP-—Å–µ—Ä–≤–µ—Ä
        _started = True                                # ‚úÖ –ü–æ–∑–Ω–∞—á–∞—î–º–æ —É—Å–ø—ñ—à–Ω–∏–π —Å—Ç–∞—Ä—Ç
        log.info("üìà Prometheus /metrics exporter started on :%s", port)  # ü™µ –õ–æ–≥ —É—Å–ø—ñ—Ö—É
    except Exception as error:                         # noqa: BLE001  # ‚ùå –ù–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞
        log.warning("‚ö†Ô∏è Failed to start Prometheus exporter: %s", error)  # ü™µ –õ–æ–≥ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
