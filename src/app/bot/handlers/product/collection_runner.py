# üèÉ app/bot/handlers/product/collection_runner.py
"""
üèÉ CollectionRunner ‚Äî –∫–µ—Ä—É—î –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó.

üîπ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:
    ‚Ä¢ –û–±–º–µ–∂—É—î –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º —á–µ—Ä–µ–∑ —Å–µ–º–∞—Ñ–æ—Ä (–∫–µ—Ä–æ–≤–∞–Ω–∏–π —Ä—ñ–≤–µ–Ω—å concurrency)
    ‚Ä¢ –†–µ—Ç—Ä–∞—ó –∑ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É (exponential backoff)
    ‚Ä¢ –¢—Ä–æ—Ç—Ç–ª–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É, —â–æ–± –Ω–µ –∑–∞—Å–ø–∞–º–∏—Ç–∏ UI-—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è–º–∏
    ‚Ä¢ –ê–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–≤–µ—Ä—à—É—î –∑–∞–¥–∞—á—ñ –ø—Ä–∏ `CancelledError` (graceful cancellation)
"""

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from telegram import Update                                             # üì¨ Telegram Update (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É handler)

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import asyncio                                                          # üîÑ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ—Å—Ç—å / —Ç–∞—Å–∫–∏ / —Å–µ–º–∞—Ñ–æ—Ä–∏
import contextlib                                                       # üß∞ –ë–µ–∑–ø–µ—á–Ω–µ –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—è –≤–∏–Ω—è—Ç–∫—ñ–≤
import logging                                                          # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π
import time                                                             # ‚è±Ô∏è –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É –¥–ª—è —Ç—Ä–æ—Ç–ª—ñ–Ω–≥—É
from typing import Awaitable, Callable, List                            # üß∞ –¢–∏–ø–∏ –¥–ª—è –∫–æ–ª–±–µ–∫—ñ–≤ —Ç–∞ —Å–ø–∏—Å–∫—ñ–≤

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.bot.handlers.product.product_handler import ProductHandler     # üõçÔ∏è –û–±—Ä–æ–±–Ω–∏–∫ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É (UI‚Äë—à–∞—Ä)
from app.bot.services.custom_context import CustomContext               # üß† –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞
from app.shared.utils.logger import LOG_NAME                            # üè∑Ô∏è –Ü–º'—è –ª–æ–≥–µ—Ä–∞ –∑ —î–¥–∏–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –º—ñ—Å—Ü—è


# ==========================
# üßæ –õ–û–ì–ï–†
# ==========================
logger = logging.getLogger(LOG_NAME)


# ==========================
# üèõÔ∏è –ö–õ–ê–° RUNNER
# ==========================
class CollectionRunner:
    """
    üèÉ –ó–∞–ø—É—Å–∫–∞—î –æ–±—Ä–æ–±–∫—É —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –æ–±–º–µ–∂–µ–Ω–Ω—è–º –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º—É, —Ä–µ—Ç—Ä–∞—è–º–∏ —Ç–∞ —Ç—Ä–æ—Ç–ª—ñ–Ω–≥–æ–º –ø—Ä–æ–≥—Ä–µ—Å—É.
    """

    def __init__(
        self,
        product_handler: ProductHandler,
        concurrency: int = 4,
        per_item_retries: int = 2,
        progress_interval_sec: float = 2.5,
    ) -> None:
        """
        ‚öôÔ∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î Runner –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏ —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞–º–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.

        Args:
            product_handler: –û–±—Ä–æ–±–Ω–∏–∫ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É (UI‚Äë—à–∞—Ä), —è–∫–∏–π —É–º—ñ—î –æ–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞—Ç–∏ URL.
            concurrency: –°–∫—ñ–ª—å–∫–∏ —Ç–æ–≤–∞—Ä—ñ–≤ –æ–±—Ä–æ–±–ª—è—î–º–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ (—Ä–æ–∑–º—ñ—Ä —Å–µ–º–∞—Ñ–æ—Ä–∞).
            per_item_retries: –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Å–ø—Ä–æ–± –Ω–∞ –æ–¥–∏–Ω URL (–≤–∫–ª—é—á–Ω–æ –∑ –ø–µ—Ä—à–æ—é —Å–ø—Ä–æ–±–æ—é + N —Ä–µ—Ç—Ä–∞—ó–≤).
            progress_interval_sec: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏ –ø—Ä–æ–≥—Ä–µ—Å—É (—Å–µ–∫).
        """
        self._product_handler = product_handler								# üõçÔ∏è –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ UI‚Äë–æ–±—Ä–æ–±–Ω–∏–∫ —Ç–æ–≤–∞—Ä—É
        self._sem = asyncio.Semaphore(concurrency)							# üö¶ –°–µ–º–∞—Ñ–æ—Ä –ª—ñ–º—ñ—Ç—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–¥–∞—á
        self._retries = per_item_retries									# üîÅ –ü–æ–ª—ñ—Ç–∏–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–µ—Ç—Ä–∞—ó–≤ –Ω–∞ —Ç–æ–≤–∞—Ä
        self._progress_interval = progress_interval_sec						# ‚è±Ô∏è –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø—É—à—ñ–≤ –ø—Ä–æ–≥—Ä–µ—Å—É

    # ==========================
    # ‚ñ∂Ô∏è –ü–£–ë–õ–Ü–ß–ù–ò–ô –ú–ï–¢–û–î
    # ==========================
    async def run(
        self,
        update: Update,
        context: CustomContext,
        urls: List[str],
        on_progress: Callable[[int, int], Awaitable[None]],
        is_cancelled: Callable[[], bool],
    ) -> int:
        """
        ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞—î –æ–±—Ä–æ–±–∫—É —Å–ø–∏—Å–∫—É URL –∑ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º—É, —Ä–µ—Ç—Ä–∞—ó–≤ —ñ —Ç—Ä–æ—Ç–ª—ñ–Ω–≥—É.

        Args:
            update: –û–±'—î–∫—Ç Telegram Update (–ø—Ä–æ–∫–∏–¥—É—î—Ç—å—Å—è –≤ product_handler).
            context: –ö–∞—Å—Ç–æ–º–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–¥–∞–Ω—ñ —Å–µ—Å—ñ—ó, –∫–µ—à—ñ, DI).
            urls: –ü–µ—Ä–µ–ª—ñ–∫ URL —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –æ–±—Ä–æ–±–∫–∏.
            on_progress: –ö–æ–ª–±–µ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É: `processed, total`.
            is_cancelled: –§—É–Ω–∫—Ü—ñ—è-–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Å–∫–∞—Å–æ–≤–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –∑–≤–µ—Ä—Ö—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º).

        Returns:
            –ö—ñ–ª—å–∫—ñ—Å—Ç—å —É—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤.
        """
        processed_count = 0												# üî¢ –õ—ñ—á–∏–ª—å–Ω–∏–∫ —É—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö –ø–æ–∑–∏—Ü—ñ–π
        total = len(urls)												# üì¶ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–±—ñ—Ç
        last_push_time = 0.0											# üïì –û—Å—Ç–∞–Ω–Ω—ñ–π —á–∞—Å –ø—É—à—É –ø—Ä–æ–≥—Ä–µ—Å—É (–¥–ª—è —Ç—Ä–æ—Ç–ª—ñ–Ω–≥—É)

        # --------------------------
        # üîß –õ–æ–∫–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –æ–¥–Ω–æ–≥–æ URL
        # --------------------------
        async def _process_one_url(url: str) -> bool:
            if is_cancelled():
                return False											# üõë –Ø–∫—â–æ –∑–≤–µ—Ä—Ö—É –≤–∂–µ —Å–∫–∞—Å—É–≤–∞–ª–∏ ‚Äî –≤–∏—Ö–æ–¥–∏–º–æ –±–µ–∑ —Ä–æ–±–æ—Ç–∏

            async with self._sem:
                delay = 0.6											# ‚è≥ –ü–æ—á–∞—Ç–∫–æ–≤–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è exponential backoff
                for attempt in range(self._retries + 1):
                    try:
                        await self._product_handler.handle_url(
                            update,
                            context,
                            url=url,
                            update_currency=False,							# üí± –ö–æ–ª–µ–∫—Ü—ñ—è –Ω–µ –ø–æ–≤–∏–Ω–Ω–∞ –ø–æ—Å—Ç—ñ–π–Ω–æ —Å–º–∏–∫–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤
                        )
                        return True									# ‚úÖ –£—Å–ø—ñ—à–Ω–æ
                    except asyncio.CancelledError:
                        logger.info("üõë Cancelled item: %s", url)
                        return False									# üßπ –ö–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ —Ü–µ–π –∞–π—Ç–µ–º
                    except Exception as e:  # noqa: BLE001 (—Å–≤—ñ–¥–æ–º–æ –ª–æ–≥–∏–º–æ –±—É–¥—å-—è–∫—É –ø–æ–º–∏–ª–∫—É —è–∫ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è)
                        logger.warning(
                            "[CollectionRunner] –ü–æ–º–∏–ª–∫–∞ (%s/%s) –Ω–∞ %s: %s",
                            attempt + 1,
                            self._retries + 1,
                            url,
                            e,
                        )
                        if attempt >= self._retries:
                            return False								# ‚ùå –í–∏—á–µ—Ä–ø–∞–ª–∏ —Å–ø—Ä–æ–±–∏ ‚Äî —Ñ—ñ–∫—Å—É—î–º–æ –ø—Ä–æ–≤–∞–ª
                        await asyncio.sleep(delay)						# üò¥ Backoff –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
                        delay *= 2										# üìà –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–æ –∑–±—ñ–ª—å—à—É—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É
                return False											# üßØ –ù–µ–≤–¥–∞—á–∞ –ø—ñ—Å–ª—è —Ü–∏–∫–ª—É —Å–ø—Ä–æ–±

        tasks = [asyncio.create_task(_process_one_url(u)) for u in urls]				# üßµ –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–¥–∞—á—ñ –æ–¥—Ä–∞–∑—É ‚Äî –≤–∏–∫–æ–Ω—É—î–º–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ

        try:
            # –û–±—Ö–æ–¥–∏–º–æ –ø–æ –º—ñ—Ä—ñ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            for fut in asyncio.as_completed(tasks):
                success = await fut
                if success:
                    processed_count += 1								# ‚ûï –†–∞—Ö—É—î–º–æ –ª–∏—à–µ —É—Å–ø—ñ—à–Ω—ñ

                # ‚è±Ô∏è –¢—Ä–æ—Ç—Ç–ª–∏–º–æ –ø—Ä–æ–≥—Ä–µ—Å, —â–æ–± –Ω–µ –¥—É–¥–æ—Å–∏—Ç–∏ UI
                now = time.monotonic()
                if (now - last_push_time) >= self._progress_interval or processed_count == total:
                    last_push_time = now
                    try:
                        await on_progress(processed_count, total)				# üì£ –ê–∫—É—Ä–∞—Ç–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
                    except Exception:  # noqa: BLE001
                        # üôà –ù–µ –∑—Ä–∏–≤–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª —á–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º–∏ –∑ UI‚Äë–æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
                        pass

        except asyncio.CancelledError:
            logger.info("üõë CollectionRunner cancelled")
            # üßπ –ê–∫—É—Ä–∞—Ç–Ω–æ –≤—ñ–¥–º—ñ–Ω—è—î–º–æ —ñ–Ω—à—ñ —Ç–∞—Å–∫–∏
            for t in tasks:
                t.cancel()
            with contextlib.suppress(Exception):
                await asyncio.gather(*tasks, return_exceptions=True)
            return processed_count										# üîô –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ, —â–æ –≤—Å—Ç–∏–≥–ª–∏ –æ–±—Ä–æ–±–∏—Ç–∏

        return processed_count											# ‚úÖ –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥—É
