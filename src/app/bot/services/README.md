# üì¶ services ‚Äî —Å–µ—Ä–≤—ñ—Å–Ω–∏–π —à–∞—Ä Telegram-–±–æ—Ç–∞
–Ñ–¥–∏–Ω–∏–π –Ω–∞–±—ñ—Ä —É—Ç–∏–ª—ñ—Ç —ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤, —è–∫–∏–º–∏ –∫–æ—Ä–∏—Å—Ç—É—é—Ç—å—Å—è –≤—Å—ñ —Ñ—ñ—á—ñ —Ç–∞ —Ö–µ–Ω–¥–ª–µ—Ä–∏: —Ç–∏–ø–æ–±–µ–∑–ø–µ—á–Ω—ñ callback-–¥–∞–Ω—ñ, —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤, –∫–∞—Å—Ç–æ–º–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —ñ –∑–∞–≥–∞–ª—å–Ω—ñ —Ç–∏–ø–∏.

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```bash
services/
‚îú‚îÄ‚îÄ üìò README.md
‚îú‚îÄ‚îÄ üìÑ __init__.py
‚îú‚îÄ‚îÄ üìÑ callback_data_factory.py
‚îú‚îÄ‚îÄ üìÑ callback_registry.py
‚îú‚îÄ‚îÄ üìÑ custom_context.py
‚îî‚îÄ‚îÄ üìÑ types.py
```

---

## üß≠ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
- –ù–∞–¥–∞—Ç–∏ —î–¥–∏–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç callback-–¥–∞–Ω–∏—Ö (`ns:name?key=value`) –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–º –±–∞–π—Ç–æ–≤–∏–º –±—é–¥–∂–µ—Ç–æ–º.
- –ó–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é/–æ—Ç—Ä–∏–º–∞–Ω–Ω—è/—Å–∫–∏–¥–∞–Ω–Ω—è callback-—Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤ —ñ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é —Å–∏–≥–Ω–∞—Ç—É—Ä.
- –Ü–Ω–∫–∞–ø—Å—É–ª—é–≤–∞—Ç–∏ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—Ä–µ–∂–∏–º–∏, –æ—Å—Ç–∞–Ω–Ω—ñ–π URL, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ callback) —É `CustomContext`.
- –û–ø–∏—Å–∞—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—ñ —Ç–∏–ø–æ–≤—ñ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏ (`CallbackHandlerType`, `Registrable`) —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —ó—Ö –¥–ª—è –≤—Å—å–æ–≥–æ –±–æ—Ç–∞.
- –°–ø—Ä–æ—Å—Ç–∏—Ç–∏ DI: —ñ–Ω—à—ñ –ø–∞–∫–µ—Ç–∏ —ñ–º–ø–æ—Ä—Ç—É—é—Ç—å —Å–µ—Ä–≤—ñ—Å–∏ —á–µ—Ä–µ–∑ `app.bot.services.__init__`, –Ω–µ —Ç–æ—Ä–∫–∞—é—á–∏—Å—å –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó —Å—Ç—Ä—É–∫—Ç—É—Ä–∏.

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
- **`__init__.py`** ‚Äî –ø—É–±–ª—ñ—á–Ω–∏–π API –ø–∞–∫–µ—Ç–∞ (—Ä–µ–µ–∫—Å–ø–æ—Ä—Ç `CallbackData`, `CallbackRegistry`, `CustomContext`, `CallbackHandlerType`, `Registrable`). –î–æ–¥–∞—î –∫–æ—Ä–æ—Ç–∫—É –¥–æ–≤—ñ–¥–∫—É —Ç–∞ –≥–∞—Ä–∞–Ω—Ç—É—î —Å—Ç–∞–±—ñ–ª—å–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏.
- **[`callback_data_factory.py`](./callback_data_factory.py)** ‚Äî —Ñ–∞–±—Ä–∏–∫–∞ `CallbackData`:
  - –≤–∞–ª—ñ–¥—É—î `ns`/`name`, –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î —Ä–µ–≥—ñ—Å—Ç—Ä, –∑–∞–±–æ—Ä–æ–Ω—è—î `?&=`;
  - `build(params)` –∑–±–∏—Ä–∞—î —Ä—è–¥–æ–∫ —ñ–∑ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ª—ñ–º—ñ—Ç—É 64 –±–∞–π—Ç–∏;
  - `budget_left()` –¥–æ–∑–≤–æ–ª—è—î –æ—Ü—ñ–Ω–∏—Ç–∏, —Å–∫—ñ–ª—å–∫–∏ –±–∞–π—Ç—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å –¥–æ –æ–±–º–µ–∂–µ–Ω–Ω—è;
  - `parse(raw)` –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ—Ä—Ç–µ–∂ `(CallbackData, Dict[str, str>)`, —ñ–≥–Ω–æ—Ä—É—é—á–∏ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ query-–ø–∞—Ä–∏.
- **[`callback_registry.py`](./callback_registry.py)** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —Ä–µ—î—Å—Ç—Ä callback-—Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤:
  - `register(feature)` —Ç–∞ `register_map()` –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è;
  - `get_handler`, `unregister`, `clear`, `items/keys/values`, `missing_keys`;
  - –º‚Äô—è–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä (–æ—á—ñ–∫—É—î—Ç—å—Å—è `async def handler(update: Update, context: CustomContext)`), –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î –ø—Ä–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∫–ª—é—á—ñ–≤.
- **[`custom_context.py`](./custom_context.py)** ‚Äî —Ä–æ–∑—à–∏—Ä—é—î PTB `CallbackContext`:
  - –¥–æ–¥–∞—î —Ç–∏–ø–æ–±–µ–∑–ø–µ—á–Ω—ñ `mode`, `url` –ø–æ–≤–µ—Ä—Ö `user_data` (–∫–ª—é—á—ñ –∑ `AppConstants`);
  - –º–∞—î —Å–ª–æ–≤–Ω–∏–∫ `callback_params` –¥–ª—è —Ä–æ–∑–ø–∞—Ä—Å–µ–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ inline-–∫–Ω–æ–ø–æ–∫;
  - –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `ApplicationBuilder(context_types=ContextTypes(context=CustomContext))`.
- **[`types.py`](./types.py)** ‚Äî –∑–∞–≥–∞–ª—å–Ω—ñ —Ç–∏–ø–∏:
  - `CallbackHandlerType` ‚Äî —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –¥–ª—è async-—Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤ callback—ñ–≤;
  - `Registrable` ‚Äî `Protocol` –¥–ª—è —Ñ—ñ—á, —â–æ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å `Mapping[CallbackData, CallbackHandlerType]`;
  - —Ä–µ–µ–∫—Å–ø–æ—Ä—Ç—É—î `CallbackData` —Ç–∞ `CustomContext`, —â–æ–± —ñ–Ω—à—ñ –º–æ–¥—É–ª—ñ –º–æ–≥–ª–∏ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤—Å–µ –∑ –æ–¥–Ω–æ–≥–æ –º—ñ—Å—Ü—è.

---

## ‚öôÔ∏è –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∏ —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è
- **AppConstants / CONST**: `CustomContext` —á–∏—Ç–∞—î –∫–ª—é—á—ñ –∑ `CONST.LOGIC.USER_DATA` –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É —Ç–∞ URL. –°–ª—ñ–¥ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ —Ü—ñ –∫–ª—é—á—ñ –ø—Ä–∏—Å—É—Ç–Ω—ñ –≤ `app/config/setup/constants.py`.
- **PTB Application**: `CustomContext` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ª–∏—à–µ —è–∫—â–æ –≤ Application –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ `context_types=ContextTypes(context=CustomContext)`.
- **InlineKeyboardButton**: —É—Å—ñ callback-–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `CallbackData.build()`; –ø—Ä–∏ —Ä—É—á–Ω–æ–º—É —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ —Ä—è–¥–∫—ñ–≤ —î —Ä–∏–∑–∏–∫ –ø–æ—Ä—É—à–∏—Ç–∏ –ª—ñ–º—ñ—Ç 64 –±–∞–π—Ç–∏, —Ç–æ–º—É —Ñ–∞–±—Ä–∏–∫—É —Ç—Ä–µ–±–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–∞–≤–∂–¥–∏.

---

## üöÄ –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
```python
from telegram.ext import ApplicationBuilder, ContextTypes
from app.bot.services import (
    CallbackData,
    CallbackRegistry,
    CustomContext,
    Registrable,
)

class FavoriteFeature(Registrable):
    def __init__(self, messenger):  # –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑ DI
        self._messenger = messenger
        self._key_toggle = CallbackData("fav", "toggle")

    async def toggle_handler(self, update, context: CustomContext) -> None:
        params = context.callback_params
        product_id = params.get("id")
        await self._messenger.toggle_favorite(update, product_id)

    def get_callback_handlers(self):
        return {self._key_toggle: self.toggle_handler}

registry = CallbackRegistry()
feature = FavoriteFeature(messenger)
registry.register(feature)

application = (
    ApplicationBuilder()
    .context_types(ContextTypes(context=CustomContext))
    .build()
)
# –¥–∞–ª—ñ registry.get_handler(...) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É CallbackHandler
```

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- `callback_data_factory`: –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ, —â–æ `build()` –≤—ñ–¥—Ö–∏–ª—è—î –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ —Å–∏–º–≤–æ–ª–∏ —Ç–∞ –¥–æ–≤–≥—ñ —Ä—è–¥–∫–∏, –∞ `parse()` –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î params (—É–Ω–∏–∫–∞–π—Ç–µ –≤–∏–ø–∞–¥–∫—ñ–≤ `?foo=&bar=1`).
- `callback_registry`: –º–æ–∫–∞–π—Ç–µ `CallbackData`/—Ö–µ–Ω–¥–ª–µ—Ä–∏ –π —Ç–µ—Å—Ç—É–π—Ç–µ `register/unregister/clear`, –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∫–ª—é—á—ñ–≤ —ñ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–∏ (–º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —á–µ—Ä–µ–∑ `caplog`).
- `custom_context`: —Å—Ç–≤–µ—Ä–¥–∂—É–π—Ç–µ, —â–æ `mode/url` –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `user_data`, –∞ `callback_params` –æ—á–∏—â—É—î—Ç—å—Å—è/–æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –º—ñ–∂ –≤–∏–∫–ª–∏–∫–∞–º–∏.
- `types.py`: –≥–∞—Ä–∞–Ω—Ç—É–π—Ç–µ, —â–æ –æ–±‚Äô—î–∫—Ç–∏, —è–∫—ñ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å `Registrable`, —Å–ø—Ä–∞–≤–¥—ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å `Mapping[CallbackData, CallbackHandlerType]` ‚Äî —Ü–µ –∑—Ä—É—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —á–µ—Ä–µ–∑ mypy/pyright.

---

## ‚úÖ –ü—Ä–∏–º—ñ—Ç–∫–∏
- –ù–µ —Å—Ç–≤–æ—Ä—é–π—Ç–µ callback-—Ä—è–¥–∫–∏ –≤—Ä—É—á–Ω—É: —Ñ–∞–±—Ä–∏–∫–∞ —Å—Ç–µ–∂–∏—Ç—å –∑–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–º –ø–æ—Ä—è–¥–∫–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —ñ –ª—ñ–º—ñ—Ç–æ–º –¥–æ–≤–∂–∏–Ω–∏.
- `CallbackRegistry` –Ω–∞–≤–º–∏—Å–Ω–æ –Ω–µ –ø—ñ–¥–Ω—ñ–º–∞—î –≤–∏–Ω—è—Ç–∫–∏ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞—Ö –∫–ª—é—á—ñ–≤, –∞–ª–µ –ª–æ–≥ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î ‚Äî –¥–∏–≤—ñ—Ç—å—Å—è –ª–æ–≥–∏ –ø—ñ–¥ —á–∞—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.
- `CustomContext` –¥—ñ–ª–∏—Ç—å `user_data` –∑ PTB; —É–Ω–∏–∫–∞–π—Ç–µ –∑–∞–ø–∏—Å—É –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–ª—é—á—ñ–≤, —â–æ–± –Ω–µ –∑–ª–∞–º–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –≥–µ—Ç—Ç–µ—Ä–∏.
- –Ø–∫—â–æ –¥–æ–¥–∞—î—Ç–µ –Ω–æ–≤–∏–π —Å–µ—Ä–≤—ñ—Å —É —Ü–µ–π –ø–∞–∫–µ—Ç, –æ–Ω–æ–≤—ñ—Ç—å README —ñ `__all__`, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—É–±–ª—ñ—á–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å—Ç–∞–±—ñ–ª—å–Ω–∏–º.
