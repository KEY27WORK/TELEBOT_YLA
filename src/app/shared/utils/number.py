# üí∞ app/shared/utils/number.py
"""
üí∞ –£—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó —á–∏—Å–ª–æ–≤–∏—Ö —Ä—è–¥–∫—ñ–≤ —É `Decimal`.

üîπ –û—á–∏—â—É—î —Ç–µ–∫—Å—Ç —Ü—ñ–Ω –≤—ñ–¥ —Å–∏–º–≤–æ–ª—ñ–≤ –≤–∞–ª—é—Ç —Ç–∞ –∑–∞–π–≤–∏—Ö —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ–≤.
üîπ –ü—ñ–¥—Ç—Ä–∏–º—É—î –∑–º—ñ—à–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ (EU/US) —Ç–∞ –±–µ–∑–ø–µ—á–Ω—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è.
üîπ –ü–æ–≤–µ—Ä—Ç–∞—î –Ω—É–ª—å–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞.
"""

from __future__ import annotations

import re                                              # üßπ –†–µ–≥—É–ª—è—Ä–Ω—ñ –≤–∏—Ä–∞–∑–∏ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è
from decimal import Decimal, InvalidOperation          # üíµ –¢–æ—á–Ω—ñ –¥–µ—Å—è—Ç–∫–æ–≤—ñ —á–∏—Å–ª–∞
from typing import Union                               # üß∞ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫—ñ–ª—å–∫–æ—Ö —Ç–∏–ø—ñ–≤ –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö

# ================================
# üßΩ –®–ê–ë–õ–û–ù–ò –û–ß–ò–©–ï–ù–ù–Ø
# ================================
_TRASH_RE = re.compile(r"[^\d,.\-]")                   # üßπ –í–∏–¥–∞–ª—è—î–º–æ —É—Å–µ, –æ–∫—Ä—ñ–º —Ü–∏—Ñ—Ä —Ç–∞ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ–≤

def sanitize_price_text(text: str) -> str:
    """–û—á–∏—â–∞—î —Ç–µ–∫—Å—Ç —Ü—ñ–Ω–∏, –∑–∞–ª–∏—à–∞—é—á–∏ –ª–∏—à–µ —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º—ñ —Å–∏–º–≤–æ–ª–∏."""
    if text is None:                                    # üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ None
        return ""
    sanitized = str(text).strip()                       # ‚úÇÔ∏è –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏
    if not sanitized:                                   # üõë –ü–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ –ø—ñ—Å–ª—è –æ–±—Ä—ñ–∑–∫–∏
        return ""
    sanitized = _TRASH_RE.sub("", sanitized)            # üßπ –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ —Å–∏–º–≤–æ–ª–∏
    if sanitized.count("-") > 1:                        # ‚ûñ –ë–∞–≥–∞—Ç–æ –º—ñ–Ω—É—Å—ñ–≤ ‚Üí –∑–∞–ª–∏—à–∞—î–º–æ –ª–∏—à–µ –ø—Ä–æ–≤—ñ–¥–Ω–∏–π
        has_leading_minus = sanitized.lstrip().startswith("-")  # üîé –ß–∏ –±—É–≤ –º—ñ–Ω—É—Å –Ω–∞ –ø–æ—á–∞—Ç–∫—É
        sanitized = ("-" if has_leading_minus else "") + sanitized.replace("-", "")  # üîß –§–æ—Ä–º—É—î–º–æ —Ä—è–¥–æ–∫ –±–µ–∑ –∑–∞–π–≤–∏—Ö –º—ñ–Ω—É—Å—ñ–≤
    return sanitized                                    # üì¨ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—á–∏—â–µ–Ω–∏–π —Ç–µ–∫—Å—Ç

def _normalize_decimal_separators(clean: str) -> str:
    """–ù–æ—Ä–º–∞–ª—ñ–∑—É—î –¥–µ—Å—è—Ç–∫–æ–≤—ñ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ —É —Ä—è–¥–∫—É —á–∏—Å–ª–∞."""
    if not clean:                                       # üõë –ü–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ ‚Üí –Ω—ñ—á–æ–≥–æ –Ω–æ—Ä–º–∞–ª—ñ–∑—É–≤–∞—Ç–∏
        return ""
    if "," in clean and "." in clean:                   # üîÄ –ü—Ä–∏—Å—É—Ç–Ω—ñ –æ–±–∏–¥–≤–∞ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ
        last_comma = clean.rfind(",")                   # üîé –û—Å—Ç–∞–Ω–Ω—è –∫–æ–º–∞
        last_dot = clean.rfind(".")                     # üîé –û—Å—Ç–∞–Ω–Ω—è –∫—Ä–∞–ø–∫–∞
        if last_comma > last_dot:                       # ‚ûó –û—Å—Ç–∞–Ω–Ω—è –∫–æ–º–∞ –ø—Ä–∞–≤—ñ—à–∞ ‚Üí –∫–æ–º–∞ = –¥—Ä–æ–±–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á
            normalized = clean.replace(".", "")         # üßπ –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫—Ä–∞–ø–∫–∏ (—Ä–æ–∑–¥—ñ–ª—é–≤–∞—á —Ç–∏—Å—è—á)
            normalized = normalized.replace(",", ".")   # üîÑ –ö–æ–º–∞ ‚Üí –¥–µ—Å—è—Ç–∫–æ–≤–∞ –∫—Ä–∞–ø–∫–∞
            return normalized                           # üì¨ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —Ä—è–¥–æ–∫
        normalized = clean.replace(",", "")             # üßπ –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–æ–º–∏ —è–∫ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ —Ç–∏—Å—è—á
        return normalized                               # üì¨ –î–µ—Å—è—Ç–∫–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á –≤–∂–µ –∫—Ä–∞–ø–∫–∞
    return clean.replace(",", ".")                      # üîÑ –Ñ –ª–∏—à–µ –∫–æ–º–∏ ‚Üí —Ç—Ä–∞–∫—Ç—É—î–º–æ —è–∫ –¥–µ—Å—è—Ç–∫–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á

def decimal_from_price_str(text: Union[str, float, int, None]) -> Decimal:
    """–ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î –∑–Ω–∞—á–µ–Ω–Ω—è —É `Decimal`, –ø—ñ–¥—Ç—Ä–∏–º—É—é—á–∏ —Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ —Ü—ñ–Ω."""
    if text is None:                                     # üõ°Ô∏è –ù–µ–º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 0
        return Decimal("0.0")
    if isinstance(text, (int, float)):                   # üî¢ –ü—Ä–æ—Å—Ç—ñ —á–∏—Å–ª–æ–≤—ñ —Ç–∏–ø–∏
        try:
            return Decimal(str(text))                    # üîÑ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ä—è–¥–æ–∫, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ—Ö–∏–±–æ–∫ float
        except Exception:                                # noqa: BLE001  # ‚ö†Ô∏è –ù–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è
            return Decimal("0.0")                        # üõü –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –±–µ–∑–ø–µ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    sanitized = sanitize_price_text(text)                # üßΩ –û—á–∏—â–∞—î–º–æ —Ä—è–¥–æ–∫
    if not sanitized or sanitized in (".", "-", "-."):   # ‚ùå –ù–µ–ø—Ä–∏–¥–∞—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        return Decimal("0.0")
    normalized = _normalize_decimal_separators(sanitized)  # üîÑ –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á—ñ
    if not normalized or normalized in (".", "-", "-."):  # ‚ùå –ó–∞–ª–∏—à–∏–ª–∏—Å—å –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ —Ä—è–¥–∫–∏
        return Decimal("0.0")
    try:
        return Decimal(normalized)                       # ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ—Ä–µ–∫—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    except InvalidOperation:                             # ‚ö†Ô∏è –†—è–¥–æ–∫ –≤—Å–µ —â–µ –Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î—Ç—å—Å—è
        return Decimal("0.0")                            # üõü –ë–µ–∑–ø–µ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
