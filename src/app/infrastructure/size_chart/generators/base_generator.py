# üìè app/infrastructure/size_chart/generators/base_generator.py
"""
üìè base_generator.py ‚Äî –ë–∞–∑–æ–≤–∏–π –∫–ª–∞—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ —Ç–∞–±–ª–∏—Ü—è–º–∏ —Ä–æ–∑–º—ñ—Ä—ñ–≤.

üîπ –ö–ª–∞—Å `BaseTableGenerator`:
    ‚Ä¢ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –±–∞–∑–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ñ (—Ä–æ–∑–º—ñ—Ä –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —à—Ä–∏—Ñ—Ç–∏)
    ‚Ä¢ –ú—ñ—Å—Ç–∏—Ç—å –ª–æ–≥—ñ–∫—É –¥–ª—è —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
    ‚Ä¢ –ú–∞—î –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏–π –º–µ—Ç–æ–¥ `generate`, —è–∫–∏–π —Ä–µ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –≤ –ø—ñ–¥–∫–ª–∞—Å–∞—Ö
"""

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
from abc import ABC, abstractmethod                                      # üìê –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ñ –±–∞–∑–æ–≤—ñ –∫–ª–∞—Å–∏
from typing import Dict, List                                            # üß∞ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from PIL import Image, ImageDraw, ImageFont                             # üñºÔ∏è –ú–∞–ª—é–≤–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.infrastructure.image_generation.font_service import FontService  # üî§ –°–µ—Ä–≤—ñ—Å —Ä–æ–±–æ—Ç–∏ –∑—ñ —à—Ä–∏—Ñ—Ç–∞–º–∏


# ================================
# üìê –ë–ê–ó–û–í–ò–ô –ö–õ–ê–° –ì–ï–ù–ï–†–ê–¢–û–†–ê
# ================================
class BaseTableGenerator(ABC):
    """
    üìê –ë–∞–∑–æ–≤–∏–π –∫–ª–∞—Å –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å —Ç–∞–±–ª–∏—Ü—å —Ä–æ–∑–º—ñ—Ä—ñ–≤.
    """

    IMG_WIDTH = 1080									# üìè –®–∏—Ä–∏–Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    IMG_HEIGHT = 1920								# üìè –í–∏—Å–æ—Ç–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    PADDING = 20									# üî≤ –í—ñ–¥—Å—Ç—É–ø –≤—ñ–¥ –∫—Ä–∞—ó–≤

    def __init__(self, size_chart: Dict[str, List], output_path: str, font_service: FontService):
        """
        ‚öôÔ∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞–±–ª–∏—Ü—ñ –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

        Args:
            size_chart (Dict[str, List]): üìä –î–∞–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–∑–º—ñ—Ä—ñ–≤.
            output_path (str): üíæ –®–ª—è—Ö –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
            font_service (FontService): üî§ –°–µ—Ä–≤—ñ—Å —à—Ä–∏—Ñ—Ç—ñ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç—É.
        """
        self.size_chart = size_chart.copy()							# üß© –ö–æ–ø—ñ—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª, —â–æ–± –Ω–µ –∑–º—ñ–Ω–∏—Ç–∏ –π–æ–≥–æ
        self.output_path = output_path							# üíæ –ö—É–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        self.font_service = font_service							# üî§ –°–µ—Ä–≤—ñ—Å —à—Ä–∏—Ñ—Ç—ñ–≤ (–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å)

        # üè∑Ô∏è –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ ‚Äî –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ —Ü–µ str
        raw_title = self.size_chart.pop("Title", "–¢–∞–±–ª–∏—Ü—è —Ä–æ–∑–º—ñ—Ä—ñ–≤")
        self.title = raw_title[0] if isinstance(raw_title, list) else raw_title
        
        self.headers = self.size_chart.pop("–†–æ–∑–º—ñ—Ä", [])				# üìå –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–Ω–∞–ø—Ä. S, M, L)
        self.image = Image.new("RGB", (self.IMG_WIDTH, self.IMG_HEIGHT), "white")	# üñºÔ∏è –ü–æ—Ä–æ–∂–Ω—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—ñ–ª–æ–≥–æ —Ñ–æ–Ω—É
        self.draw = ImageDraw.Draw(self.image)					# ‚úèÔ∏è –û–± º—î–∫—Ç –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è

    def draw_text_centered(self, text, x, y, font, fill="black"):
        """
        üéØ –ú–∞–ª—é—î —Ç–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤—ñ–¥–Ω–æ—Å–Ω–æ –∑–∞–¥–∞–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.

        Args:
            text (str): üìù –¢–µ–∫—Å—Ç–æ–≤–∏–π —Ä—è–¥–æ–∫.
            x (int): üìç –¶–µ–Ω—Ç—Ä X.
            y (int): üìç –¶–µ–Ω—Ç—Ä Y.
            font (ImageFont): üî§ –û–± º—î–∫—Ç —à—Ä–∏—Ñ—Ç—É.
            fill (str): üé® –ö–æ–ª—ñ—Ä —Ç–µ–∫—Å—Ç—É.
        """
        bbox = self.draw.textbbox((x, y), text, font=font)			# üìê –†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫—É
        text_x = x - (bbox[2] - bbox[0]) // 2					# ‚ÜîÔ∏è –¶–µ–Ω—Ç—Ä—É—î–º–æ –ø–æ X
        text_y = y - (bbox[3] - bbox[1]) // 2					# ‚ÜïÔ∏è –¶–µ–Ω—Ç—Ä—É—î–º–æ –ø–æ Y
        self.draw.text((text_x, text_y), text, font=font, fill=fill)	# üñãÔ∏è –ú–∞–ª—é—î–º–æ —Ç–µ–∫—Å—Ç

    @abstractmethod
    async def generate(self) -> str:
        """
        üöß –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.

        Returns:
            str: üíæ –®–ª—è—Ö –¥–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
        """
        raise NotImplementedError("–ú–µ—Ç–æ–¥ generate –º–∞—î –±—É—Ç–∏ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —É –ø—ñ–¥–∫–ª–∞—Å—ñ.")