# üì¶ app/infrastructure/delivery/meest_delivery_service.py
"""
üì¶ meest_delivery_service.py ‚Äî –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —Å–µ—Ä–≤—ñ—Å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏ Meest –¥–ª—è –º—É–ª—å—Ç–∏-—Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏.

üîπ –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞:
- –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ç–∞—Ä–∏—Ñ—ñ–≤
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫—Ä–∞—ó–Ω: –°–®–ê üá∫üá∏, –ë—Ä–∏—Ç–∞–Ω—ñ—è üá¨üáß, –ù—ñ–º–µ—á—á–∏–Ω–∞ üá©üá™, –ü–æ–ª—å—â–∞ üáµüá±
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ç–∏–ø—É –¥–æ—Å—Ç–∞–≤–∫–∏: –∞–≤—ñ–∞ ‚úàÔ∏è
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤

üîß –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π Python (–±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π)
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
"""

# üî† –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
import logging
from typing import Tuple, Optional

# ============================================
# üèõÔ∏è –°–ï–†–í–Ü–° –†–û–ó–†–ê–•–£–ù–ö–£ –î–û–°–¢–ê–í–ö–ò MEEST
# ============================================
class MeestDeliveryService:
    """üöö –ì–æ–ª–æ–≤–Ω–∏–π —Å–µ—Ä–≤—ñ—Å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ Meest."""

    # === üè¶ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∞–ª—é—Ç –∑–∞ –∫—Ä–∞—ó–Ω–∞–º–∏ ===
    CURRENCY = {
        "us": "USD",       # üá∫üá∏ –°–®–ê ‚Äî –¥–æ–ª–∞—Ä
        "uk": "GBP",       # üá¨üáß –ë—Ä–∏—Ç–∞–Ω—ñ—è ‚Äî —Ñ—É–Ω—Ç
        "germany": "EUR",  # üá©üá™ –ù—ñ–º–µ—á—á–∏–Ω–∞ ‚Äî —î–≤—Ä–æ
        "poland": "PLN"    # üáµüá± –ü–æ–ª—å—â–∞ ‚Äî –∑–ª–æ—Ç–∏–π
    }

    @classmethod
    def get_price(cls, country: str, method: str, type_: str,
        weight_kg: float, volumetric_weight_kg: Optional[float] = None) -> float:
        """
        üí∏ –û—Å–Ω–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ Meest.

        üì• –í—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:
        - country: –∫—Ä–∞—ó–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (us / uk / germany / poland)
        - method: –º–µ—Ç–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ (air)
        - type_: —Ç–∏–ø –æ—Ç—Ä–∏–º–∞–Ω–Ω—è (courier)
        - weight_kg: —Ñ–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞ —É –∫—ñ–ª–æ–≥—Ä–∞–º–∞—Ö
        - volumetric_weight_kg: –æ–±'—î–º–Ω–∞ –≤–∞–≥–∞ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

        üì§ –ü–æ–≤–µ—Ä—Ç–∞—î:
        - –≤–∞—Ä—Ç—ñ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —É –ª–æ–∫–∞–ª—å–Ω—ñ–π –≤–∞–ª—é—Ç—ñ –∫—Ä–∞—ó–Ω–∏
        """
        # üîΩ –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        country = country.lower()
        method = method.lower()
        type_ = type_.lower()

        # üìù –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É
        logging.info(
            f"üì¶ Meest —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫: –∫—Ä–∞—ó–Ω–∞={country}, –º–µ—Ç–æ–¥={method}, "
            f"—Ç–∏–ø={type_}, –≤–∞–≥–∞={weight_kg} –∫–≥"
        )

        # üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        if country not in cls.CURRENCY or method != "air":
            logging.error(f"‚ùå –ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è: {country}, {method}")
            raise ValueError(f"‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è: {country}, {method}")

        # üìä –û—Å–Ω–æ–≤–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
        if country == "us":
            price = cls._calc_us(weight_kg)
        elif country == "uk":
            price = cls._calc_uk(weight_kg)
        elif country == "germany":
            price = cls._calc_germany(weight_kg)
        elif country == "poland":
            price = cls._calc_poland(weight_kg)
        else:
            logging.error(f"‚ùå –ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∞ –∫—Ä–∞—ó–Ω–∞: {country}")
            raise ValueError(f"‚ùå –ù–µ–ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∞ –∫—Ä–∞—ó–Ω–∞: {country}")

        # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        logging.debug(
            f"‚úÖ –û–±—Ä–∞—Ö–æ–≤–∞–Ω–æ —Ç–∞—Ä–∏—Ñ: {country.upper()} ({method}) ‚Üí {price:.2f} "
            f"{cls.CURRENCY[country]}"
        )

        return round(price, 2)


    # === ‚úàÔ∏è –ü—Ä–∏–≤–∞—Ç–Ω—ñ –º–µ—Ç–æ–¥–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫—Ä–∞—ó–Ω–∏ ===

    # ==========================
    # üá∫üá∏ –°–®–ê (USD) ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–≤–µ—Ä–µ–π
    # ==========================
    @staticmethod
    def _calc_us(weight: float) -> float:
        """
        üá∫üá∏ –°–®–ê (door):
        - –¥–æ 0.5 –∫–≥: $5.90
        - 0.5‚Äì1 –∫–≥: $8.19 (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç–∞–≤–∫–∞)
        - –ø–æ–Ω–∞–¥ 1 –∫–≥: $8.69/–∫–≥, –∞–ª–µ –Ω–µ –º–µ–Ω—à–µ $8.19 –∑–∞ –≤—Å—é –ø–æ—Å–∏–ª–∫—É
        """
        if weight <= 0.5:
            return 5.90                            # –¥–æ 0.5 –∫–≥: —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞
        if weight <= 1:
            return 8.19                            # –¥–æ 1 –∫–≥: –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—Ç–∞–≤–∫–∞
        return max(8.69 * weight, 8.19)            # –ø–æ–Ω–∞–¥ 1 –∫–≥: $8.69/–∫–≥, –∞–ª–µ –º—ñ–Ω—ñ–º—É–º $8.19

    # ==========================
    # üá¨üáß –í–µ–ª–∏–∫–∞ –ë—Ä–∏—Ç–∞–Ω—ñ—è (GBP)
    # ==========================
    @staticmethod
    def _calc_uk(weight: float) -> float:
        """
        üá¨üáß –í–µ–ª–∏–∫–∞ –ë—Ä–∏—Ç–∞–Ω—ñ—è (door):
        - –¥–æ 2 –∫–≥: ¬£8.05 + ¬£1.45/–∫–≥
        - 2‚Äì10 –∫–≥: ¬£5.15 + ¬£2.55/–∫–≥
        - –ø–æ–Ω–∞–¥ 10 –∫–≥: ¬£5.15 + ¬£2.45/–∫–≥
        """
        if weight <= 2:
            return 8.05 + 1.45 * weight  # –¥–æ 2 –∫–≥: ¬£8.05 + ¬£1.45/–∫–≥
        if weight <= 10:
            return 5.15 + 2.55 * weight  # 2‚Äì10 –∫–≥: ¬£5.15 + ¬£2.55/–∫–≥
        return 5.15 + 2.45 * weight      # –ø–æ–Ω–∞–¥ 10 –∫–≥: ¬£5.15 + ¬£2.45/–∫–≥

    # ==========================
    # üá©üá™ –ù—ñ–º–µ—á—á–∏–Ω–∞ (EUR)
    # ==========================
    @staticmethod
    def _calc_germany(weight: float) -> float:
        """
        üá©üá™ –ù—ñ–º–µ—á—á–∏–Ω–∞ (door):
        - –¥–æ 0.5 –∫–≥: ‚Ç¨5.00
        - –¥–æ 2.25 –∫–≥: ‚Ç¨9.50
        - –¥–æ 5 –∫–≥: ‚Ç¨4.50/–∫–≥
        - –¥–æ 10 –∫–≥: ‚Ç¨3.75/–∫–≥
        - –¥–æ 20 –∫–≥: ‚Ç¨3.50/–∫–≥
        - –ø–æ–Ω–∞–¥ 20 –∫–≥: ‚Ç¨3.30/–∫–≥
        """
        if weight <= 0.5:
            return 5.00                  # –¥–æ 0.5 –∫–≥: ‚Ç¨5.00
        if weight <= 2.25:
            return 9.50                  # –¥–æ 2.25 –∫–≥: ‚Ç¨9.50
        if weight <= 5:
            return 4.50 * weight         # –¥–æ 5 –∫–≥: ‚Ç¨4.50/–∫–≥
        if weight <= 10:
            return 3.75 * weight         # –¥–æ 10 –∫–≥: ‚Ç¨3.75/–∫–≥
        if weight <= 20:
            return 3.50 * weight         # –¥–æ 20 –∫–≥: ‚Ç¨3.50/–∫–≥
        return 3.30 * weight             # –ø–æ–Ω–∞–¥ 20 –∫–≥: ‚Ç¨3.30/–∫–≥

    # ==========================
    # üáµüá± –ü–æ–ª—å—â–∞ (PLN)
    # ==========================
    @staticmethod
    def _calc_poland(weight: float) -> float:
        """
        üáµüá± –ü–æ–ª—å—â–∞ (door):
        - –¥–æ 0.5 –∫–≥: 5 PLN
        - –¥–æ 2.55 –∫–≥: 7.50 PLN
        - –¥–æ 5 –∫–≥: 3.25 PLN/–∫–≥
        - –¥–æ 10 –∫–≥: 2.60 PLN/–∫–≥
        - –¥–æ 20 –∫–≥: 2.25 PLN/–∫–≥
        - –ø–æ–Ω–∞–¥ 20 –∫–≥: 2.10 PLN/–∫–≥
        """
        if weight <= 0.5:
            return 5.00                  # –¥–æ 0.5 –∫–≥: 5 PLN
        if weight <= 2.55:
            return 7.50                  # –¥–æ 2.55 –∫–≥: 7.50 PLN
        if weight <= 5:
            return 3.25 * weight         # –¥–æ 5 –∫–≥: 3.25 PLN/–∫–≥
        if weight <= 10:
            return 2.60 * weight         # –¥–æ 10 –∫–≥: 2.60 PLN/–∫–≥
        if weight <= 20:
            return 2.25 * weight         # –¥–æ 20 –∫–≥: 2.25 PLN/–∫–≥
        return 2.10 * weight             # –ø–æ–Ω–∞–¥ 20 –∫–≥: 2.10 PLN/–∫–≥

    @classmethod 
    def calculate_meest_delivery(cls, weight: float) -> float:
        """‚úàÔ∏è –î–æ—Å—Ç–∞–≤–∫–∞ Meest –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–∞–≥–∏.

        üîπ –õ–æ–≥—ñ–∫–∞ —Ç–∞—Ä–∏—Ñ—É Meest –¥–ª—è –°–®–ê:
        - –¥–æ 1 —Ñ—É–Ω—Ç–∞ (–ø—Ä–∏–±–ª–∏–∑–Ω–æ 0.45 –∫–≥): —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞ —Å—Ç–∞–≤–∫–∞ $5.90
        - –∑–∞ –∫–æ–∂–µ–Ω –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ñ—É–Ω—Ç –ø–æ–Ω–∞–¥ 1 –¥–æ–¥–∞—î—Ç—å—Å—è $3.50

        üî∏ –§–æ—Ä–º—É–ª–∞ –ø—ñ—Å–ª—è 1 —Ñ—É–Ω—Ç–∞:
        full_price = $5.90 + ($3.50 * (–≤–∞–≥–∞ - 1 —Ñ—É–Ω—Ç))
        """
        if weight <= 1:
            return 5.90  # üì¶ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–ª—è –ª–µ–≥–∫–∏—Ö –ø–æ—Å–∏–ª–æ–∫
        return 5.90 + (weight - 1) * 3.5  # üì¶ –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Ü—ñ–Ω–∏ –∑–∞ –¥–æ–¥–∞—Ç–∫–æ–≤—É –≤–∞–≥—É