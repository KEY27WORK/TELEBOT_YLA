# üìê app/infrastructure/size_chart/services/table_geometry_service.py
"""
üìê table_geometry_service.py ‚Äî –°–µ—Ä–≤—ñ—Å –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≥–µ–æ–º–µ—Ç—Ä—ñ—ó —Ç–∞–±–ª–∏—Ü—å —Ä–æ–∑–º—ñ—Ä—ñ–≤.

üîπ –ö–ª–∞—Å `TableGeometryService`:
    ‚Ä¢ –í–∏—Ä–∞—Ö–æ–≤—É—î –º–∞—Å—à—Ç–∞–±, —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞ —à—Ä–∏—Ñ—Ç–∏ –ø—ñ–¥ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
    ‚Ä¢ –ü—Ä–∞—Ü—é—î –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚Äî –¥–ª—è –±—É–¥—å-—è–∫–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∫–æ–ª–æ–Ω–æ–∫.
    ‚Ä¢ –Ü–Ω–∫–∞–ø—Å—É–ª—é—î –ª–æ–≥—ñ–∫—É –≤—ñ–¥—Å—Ç—É–ø—ñ–≤, —à—Ä–∏—Ñ—Ç—ñ–≤, –º–∞—Å—à—Ç–∞–±—É.
"""

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from PIL import ImageFont                                    # üñãÔ∏è –®—Ä–∏—Ñ—Ç–∏ –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
from typing import List, Dict                                # üß∞ –¢–∏–ø–∏ –¥–∞–Ω–∏—Ö


# ================================
# üìê –ö–õ–ê–° –†–û–ó–†–ê–•–£–ù–ö–£ –ì–ï–û–ú–ï–¢–†–Ü–á
# ================================
class TableGeometryService:
    """
    üìê –°–µ—Ä–≤—ñ—Å –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –º–∞–∫–µ—Ç–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—ó —Ç–∞–±–ª–∏—Ü—ñ (–ø–æ–∑–∏—Ü—ñ—ó, —à—Ä–∏—Ñ—Ç–∏, –º–∞—Å—à—Ç–∞–±–∏).
    """

    def __init__(self, img_width: int, img_height: int, padding: int):
        self.img_width = img_width									# üìê –®–∏—Ä–∏–Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        self.img_height = img_height								# üìè –í–∏—Å–æ—Ç–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        self.padding = padding										# üî≤ –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –≤—ñ–¥—Å—Ç—É–ø –ø–æ –∫—Ä–∞—è—Ö

    def calculate_layout(
        self,
        headers: List[str],
        parameters: Dict[str, List[str]],
        base_font_size: int,
        font_service,
    ) -> dict:
        """
        üìä –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Ä–æ–∑–º—ñ—Ä–∏, –≤—ñ–¥—Å—Ç—É–ø–∏, –º–∞—Å—à—Ç–∞–± –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ.

        Args:
            headers (List[str]): üè∑Ô∏è –ù–∞–∑–≤–∏ –∫–æ–ª–æ–Ω–æ–∫ (—Ä–æ–∑–º—ñ—Ä–∏: S, M, L...)
            parameters (Dict[str, List[str]]): üìã –ù–∞–∑–≤–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ + –∑–Ω–∞—á–µ–Ω–Ω—è
            base_font_size (int): üî§ –ë–∞–∑–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É
            font_service: üß© –°–µ—Ä–≤—ñ—Å –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —à—Ä–∏—Ñ—Ç—ñ–≤ —Ç–∞ —à–∏—Ä–∏–Ω–∏ —Ç–µ–∫—Å—Ç—É

        Returns:
            dict: –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ layout-–∞ (—à–∏—Ä–∏–Ω–∏, –≤—ñ–¥—Å—Ç—É–ø–∏, —à—Ä–∏—Ñ—Ç–∏ —Ç–æ—â–æ)
        """
        max_table_width = self.img_width - 2 * self.padding				# üî≤ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ —Ç–∞–±–ª–∏—Ü—ñ
        max_table_height = self.img_height - 2 * self.padding				# üî≤ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ

        param_font = font_service.get_font("bold", base_font_size)					# üî§ –û—Ç—Ä–∏–º—É—î–º–æ –∂–∏—Ä–Ω–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ª—ñ–≤–æ—ó –∫–æ–ª–æ–Ω–∫–∏
        max_param_width = max(
            font_service.get_text_width(param, param_font) for param in parameters.keys()
        )															# üìè –í–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–∞–π—à–∏—Ä—à–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä

        first_col_width = max(max_param_width + 50, 250)							# üì¶ –ú—ñ–Ω—ñ–º—É–º 250 –∞–±–æ —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –∑–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏

        num_sizes = len(headers)                       							# üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–ª–æ–Ω–æ–∫ (—Ä–æ–∑–º—ñ—Ä—ñ–≤)
        num_gaps = num_sizes - 1                       							# ‚ûñ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–º—ñ–∂–∫—ñ–≤ –º—ñ–∂ –Ω–∏–º–∏
        min_spacing = 10                               							# üîò –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –∫–æ–ª–æ–Ω–∫–∞–º–∏
        min_width = 60                                 							# üî≤ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –æ–¥–Ω—ñ—î—ó –∫–æ–ª–æ–Ω–∫–∏

        remaining_width = max_table_width - first_col_width						# üìê –°–∫—ñ–ª—å–∫–∏ –º—ñ—Å—Ü—è –∑–∞–ª–∏—à–∏–ª–æ—Å—è –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ—ó –∫–æ–ª–æ–Ω–∫–∏
        column_width = (remaining_width - num_gaps * min_spacing) // num_sizes			# üìè –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —à–∏—Ä–∏–Ω–∏ –∫–æ–ª–æ–Ω–∫–∏

        spacing = (
            min_spacing if column_width >= min_width else
            (remaining_width - num_sizes * min_width) // num_gaps
        )													# üîÅ –ö–æ—Ä–∏–≥—É—î–º–æ spacing —è–∫—â–æ –Ω–µ –≤–º—ñ—â—É—î—Ç—å—Å—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ

        column_width = max(column_width, min_width)							# ‚úÖ –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ —â–æ –∫–æ–ª–æ–Ω–∫–∞ –Ω–µ –º–µ–Ω—à–∞ –∑–∞ –º—ñ–Ω—ñ–º—É–º

        cell_height = 80											# üî≥ –í–∏—Å–æ—Ç–∞ –æ–¥–Ω—ñ—î—ó –∫–ª—ñ—Ç–∏–Ω–∫–∏ (–±–µ–∑ –º–∞—Å—à—Ç–∞–±—É)
        title_font_size = 50										# üî§ –†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ
        padding_inside = 20										# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ –º—ñ–∂ –±–ª–æ–∫–∞–º–∏

        actual_width = (
            first_col_width + num_sizes * column_width + (num_sizes - 1) * spacing
        )													# üìê –ü–æ–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞ –≤—Å—ñ—î—ó —Ç–∞–±–ª–∏—Ü—ñ

        actual_height = (
            (len(parameters) + 1) * cell_height + title_font_size + padding_inside * 3
        )													# üìè –í–∏—Å–æ—Ç–∞ —Ç–∞–±–ª–∏—Ü—ñ –∑ —É—Å—ñ–º–∞ —Ä—è–¥–∫–∞–º–∏, –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —ñ –≤—ñ–¥—Å—Ç—É–ø–∞–º–∏

        scale_factor = min(0.85, max_table_width / actual_width, max_table_height / actual_height)	# üî¨ –ú–∞—Å—à—Ç–∞–± –¥–ª—è –≤–ø–∏—Å—É–≤–∞–Ω–Ω—è –≤ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        
        scale_factor = max(scale_factor, 0.5)  # üÜï –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±


        return {
            "first_col_width": first_col_width, 						# üì¶ –®–∏—Ä–∏–Ω–∞ –ø–µ—Ä—à–æ—ó (–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤) –∫–æ–ª–æ–Ω–∫–∏
            "column_width": column_width, 							# üß± –®–∏—Ä–∏–Ω–∞ –∫–æ–∂–Ω–æ—ó –∫–æ–ª–æ–Ω–∫–∏ –∑ —Ä–æ–∑–º—ñ—Ä–∞–º–∏
            "column_spacing": spacing, 								# ‚ÜîÔ∏è –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∫–æ–ª–æ–Ω–∫–∞–º–∏
            "cell_height": int(cell_height * scale_factor), 				# üî≥ –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∞ –≤–∏—Å–æ—Ç–∞ —Ä—è–¥–∫—ñ–≤
            "title_font_size": int(title_font_size * scale_factor),				# üî§ –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            "scale_factor": scale_factor, 							# üîç –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
            "padding_inside": padding_inside, 							# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –≤—ñ–¥—Å—Ç—É–ø
        }