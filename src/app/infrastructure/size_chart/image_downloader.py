# üñºÔ∏è app/infrastructure/size_chart/image_downloader.py
"""
üñºÔ∏è image_downloader.py ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ URL.

üîπ –ö–ª–∞—Å `ImageDownloader`:
    ‚Ä¢ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ httpx
    ‚Ä¢ –°—Ç–≤–æ—Ä—é—î –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, —è–∫—â–æ —ó—ó –Ω–µ —ñ—Å–Ω—É—î
    ‚Ä¢ –ü–æ–≤–µ—Ä—Ç–∞—î —à–ª—è—Ö –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É –∞–±–æ None —É —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏
"""

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging											        # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π
from pathlib import Path										# üìÅ –®–ª—è—Ö–∏ –¥–æ —Ñ–∞–π–ª—ñ–≤
from typing import Optional									    # üß∞ –¢–∏–ø—ñ–∑–∞—Ü—ñ—è

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
import httpx												    # üåç HTTP-–∫–ª—ñ—î–Ω—Ç –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ
from app.shared.utils.logger import LOG_NAME							# üßæ –Ü–º'—è –ª–æ–≥–≥–µ—Ä–∞

logger = logging.getLogger(LOG_NAME)									# üõ†Ô∏è –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ª–æ–≥–≥–µ—Ä–∞


# ================================
# üñºÔ∏è –ö–õ–ê–° –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó–û–ë–†–ê–ñ–ï–ù–¨
# ================================
class ImageDownloader:
    """
    üì• –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ URL —ñ –∑–±–µ—Ä—ñ–≥–∞—î –π–æ–≥–æ –Ω–∞ –¥–∏—Å–∫.
    """

    async def download(self, img_url: str, output_path: Path) -> Optional[Path]:
        """
        üöÄ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ URL —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î –π–æ–≥–æ —É –≤–∫–∞–∑–∞–Ω–∏–π —à–ª—è—Ö.

        Args:
            img_url (str): üîó URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            output_path (Path): üìÅ –ü–æ–≤–Ω–∏–π —à–ª—è—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É

        Returns:
            Optional[Path]: ‚úÖ –®–ª—è—Ö –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–±–æ None –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        """
        logger.info(f"üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ {img_url}...")						            # üßæ –õ–æ–≥ URL –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

        if not img_url:
            logger.error("‚ùå URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ–π!")							                   # ‚ùó –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø–æ—Ä–æ–∂–Ω—ñ–π URL
            return None

        try:
            async with httpx.AsyncClient() as client:
                response = await client.get(img_url, follow_redirects=True, timeout=30.0)		    # üåê GET-–∑–∞–ø–∏—Ç –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                response.raise_for_status()										                    # ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—É (200 OK)

            output_path.parent.mkdir(parents=True, exist_ok=True)					                # üìÅ –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, —è–∫—â–æ —ó—ó –Ω–µ–º–∞
            with open(output_path, "wb") as file:
                file.write(response.content)									                    # üíæ –ó–∞–ø–∏—Å –±–∞–π—Ç—ñ–≤ —É —Ñ–∞–π–ª

            logger.info(f"‚úÖ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {output_path}")			                # üßæ –õ–æ–≥ –ø—Ä–æ —É—Å–ø—ñ—Ö
            return output_path

        except httpx.HTTPStatusError as e:
            logger.error(f"‚ùå HTTP-–ø–æ–º–∏–ª–∫–∞ {e.response.status_code} –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ {img_url}")	    # üö® –û–±—Ä–æ–±–∫–∞ HTTP-–ø–æ–º–∏–ª–æ–∫
            return None

        except Exception as e:
            logger.error(f"‚ùå –ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: {e}")			            # ‚ö†Ô∏è –Ü–Ω—à—ñ –ø–æ–º–∏–ª–∫–∏
            return None