# üì¨ app/bot/ui/messengers/availability_messenger.py
"""
üì¨ availability_messenger.py ‚Äî –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–≤—ñ—Ç—ñ–≤ –ø—Ä–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —É Telegram.

üîπ –ö–ª–∞—Å `AvailabilityMessenger`:
- –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –Ω–∞ —Ç–æ–≤–∞—Ä
- –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É (—è–∫—â–æ —î)
- –í–∏–≤–æ–¥–∏—Ç—å –ø—É–±–ª—ñ—á–Ω–∏–π –∑–≤—ñ—Ç —ñ –∞–¥–º—ñ–Ω—Å—å–∫–∏–π –∑–≤—ñ—Ç
"""

# üåê –ó–æ–≤–Ω—ñ—à–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
from telegram import Message, Update                                    # ü§ñ Telegram Bot API (type stubs –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ)

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
import logging                                                          # üßæ –õ–æ–≥—É–≤–∞–Ω–Ω—è –∫—Ä–æ–∫—ñ–≤ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è
from typing import Final                                                # üß∞ –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ –Ω–µ–∑–º—ñ–Ω–Ω—ñ—Å—Ç—å –ª–æ–≥–µ—Ä–∞

# üß© –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –º–æ–¥—É–ª—ñ –ø—Ä–æ—î–∫—Ç—É
from app.infrastructure.availability.availability_processing_service import (
    ProcessedAvailabilityData,                                          # üì¶ DTO –∑ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ –ø—Ä–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å
)
from app.shared.utils.logger import LOG_NAME                            # üè∑Ô∏è –ì–ª–æ–±–∞–ª—å–Ω–µ —ñ–º'—è –ª–æ–≥–µ—Ä–∞ –ø—Ä–æ—î–∫—Ç—É


# ================================
# üì¨ –ú–ï–°–ï–ù–î–ñ–ï–† –ù–ê–Ø–í–ù–û–°–¢–Ü
# ================================
logger: Final = logging.getLogger(LOG_NAME)                              # üßæ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –º–æ–¥—É–ª—å–Ω–∏–π –ª–æ–≥–µ—Ä


class AvailabilityMessenger:
    """
    üì¨ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∑–≤—ñ—Ç—ñ–≤ –ø—Ä–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —É Telegram.
    """

    # ================================
    # üì§ –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨
    # ================================
    async def send(self, update: Update, data: ProcessedAvailabilityData) -> None:
        """
        üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ñ–æ—Ç–æ/–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–≤–∞—Ä—É, –ø—É–±–ª—ñ—á–Ω–∏–π —ñ –∞–¥–º—ñ–Ω—Å—å–∫–∏–π –∑–≤—ñ—Ç–∏.

        Args:
            update (Update): üì¨ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ Telegram (–º—ñ—Å—Ç–∏—Ç—å message/chat)
            data (ProcessedAvailabilityData): üì¶ –û–±—Ä–æ–±–ª–µ–Ω—ñ –¥–∞–Ω—ñ (–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –∑–≤—ñ—Ç–∏, URL)
        """
        if update.message is None:                                        # üö´ Callback –±–µ–∑ message ‚Üí –Ω–µ–º–∞—î –∫—É–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏
            return                                                       # üõë –ê–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–≤–µ—Ä—à—É—î–º–æ

        message: Message = update.message                                 # üîí –õ–æ–∫–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –±–µ–∑ Optional –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ

        caption = (                                                       # üè∑Ô∏è HTML-–∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ–∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –Ω–∞ –∫–∞—Ä—Ç–∫—É —Ç–æ–≤–∞—Ä—É
            f"<b><a href='{data.header.product_url}'>{data.header.title}</a></b>"
        )

        if data.header.image_url:                                         # üñºÔ∏è –Ø–∫—â–æ —î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Äî —Å–ø–µ—Ä—à—É –Ω–∞–¥—Å–∏–ª–∞—î–º–æ —Ñ–æ—Ç–æ
            await message.reply_photo(                                    # ‚úâÔ∏è –§–æ—Ç–æ + –æ–ø–∏—Å
                photo=data.header.image_url,                              # üåÑ URL —Ñ–æ—Ç–æ
                caption=caption,                                          # üè∑Ô∏è –ü—ñ–¥–ø–∏—Å
                parse_mode="HTML",                                        # üÖ∑ HTML-—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
            )
        else:                                                             # üí¨ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ–º–∞—î ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ª–∏—à–µ —Ç–µ–∫—Å—Ç
            await message.reply_text(caption, parse_mode="HTML")          # üì® HTML-–∑–∞–≥–æ–ª–æ–≤–æ–∫

        await message.reply_text(                                         # üì¢ –ü—É–±–ª—ñ—á–Ω–∏–π –∑–≤—ñ—Ç (–≤–∏–¥–∏–º–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É)
            data.reports.public_report,                                   # üìÑ –ö–æ–Ω—Ç–µ–Ω—Ç –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∑–≤—ñ—Ç—É
            parse_mode="HTML",                                            # üÖ∑ HTML-—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
        )
        await message.reply_text(                                         # üîí –ê–¥–º—ñ–Ω—Å—å–∫–∏–π –∑–≤—ñ—Ç (–¥–µ—Ç–∞–ª—å–Ω–∏–π)
            data.reports.admin_report,                                    # üìÑ –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤
            parse_mode="HTML",                                            # üÖ∑ HTML-—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
        )

        logger.info(                                                      # üßæ –ê—É–¥–∏—Ç-–ª–æ–≥ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
            "‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–≤—ñ—Ç–∏ –ø—Ä–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –¥–ª—è: %s",
            data.header.title,
        )
