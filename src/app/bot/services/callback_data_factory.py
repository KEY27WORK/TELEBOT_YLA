# üè≠ app/bot/services/callback_data_factory.py
"""
üè≠ callback_data_factory.py ‚Äî –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–∏–ø–æ–±–µ–∑–ø–µ—á–Ω–∏—Ö callback-–¥–∞–Ω–∏—Ö.

üîπ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:
    ‚Ä¢ –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫—ñ —Ç–∞ –≤–∞–ª—ñ–¥–Ω—ñ `callback_data` (–¥–æ 64 –±–∞–π—Ç)
    ‚Ä¢ –ù–∞–¥—ñ–π–Ω–æ –∫–æ–¥—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (query string) —Ç–∞ –¥–µ–∫–æ–¥—É–≤–∞—Ç–∏ —ó—Ö –Ω–∞–∑–∞–¥
    ‚Ä¢ –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —î–¥–∏–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç `ns:name?key=value`

‚úÖ –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó:
    ‚Ä¢ –í–∞–ª—ñ–¥–∞—Ü—ñ—è `ns`/`name` (–¥–æ–ø—É—Å—Ç–∏–º—ñ —Å–∏–º–≤–æ–ª–∏, –¥–æ–≤–∂–∏–Ω–∞)
    ‚Ä¢ –°—Ç–∞–±—ñ–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ (sorted) –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–æ—Å—Ç—ñ
    ‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—É 64 –±–∞–π—Ç–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º UTF‚Äë8
    ‚Ä¢ –ü–µ—Ä–µ—Ö—ñ–¥–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å: —Å—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥ `.id()` –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π (deprecated)
    ‚Ä¢ –î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ `.budget_left()` –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ ¬´–±–∞–π—Ç–æ–≤–æ–≥–æ –±—é–¥–∂–µ—Ç—É¬ª
"""

# üî† –°–∏—Å—Ç–µ–º–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏
from __future__ import annotations

import re
from dataclasses import dataclass
from typing import Dict, Final, Mapping, Optional, Tuple					# üß∞ –¢–∏–ø–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
from urllib.parse import parse_qs, urlencode								# üîó –ö–æ–¥—É–≤–∞–Ω–Ω—è/–¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è query string


# ================================
# ‚öôÔ∏è –ö–û–ù–°–¢–ê–ù–¢–ò –¢–ê –í–ê–õ–Ü–î–ê–¶–Ü–Ø
# ================================
TG_CALLBACK_MAX_BYTES: Final[int] = 64									# üìè –ñ–æ—Ä—Å—Ç–∫–∏–π –ª—ñ–º—ñ—Ç Telegram API –¥–ª—è callback_data

# ‚úÖ –î–æ–∑–≤–æ–ª–µ–Ω—ñ —Å–∏–º–≤–æ–ª–∏ —Ç–∞ –≥—Ä–∞–Ω–∏—á–Ω–∞ –¥–æ–≤–∂–∏–Ω–∞ –¥–ª—è ns/name
_NS_NAME_RE: Final[re.Pattern[str]] = re.compile(r"^[a-z0-9_:-]{1,32}$")	# üîê –í–∞–ª—ñ–¥–∞—Ü—ñ—è –±–∞–∑–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ (namespace:name)


# ================================
# üèõÔ∏è –ö–õ–ê–°-–ö–õ–Æ–ß –î–õ–Ø CALLBACK
# ================================
@dataclass(frozen=True, slots=True)
class CallbackData:
    """
    üß© –¢–∏–ø–æ–±–µ–∑–ø–µ—á–Ω–∏–π –æ–±'—î–∫—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ callback-–¥–∞–Ω–∏–º–∏.

    –ó–∞–±–µ–∑–ø–µ—á—É—î:
    - Namespace-driven —Å—Ç—Ä—É–∫—Ç—É—Ä—É (`ns:name`)
    - –ë–µ–∑–ø–µ—á–Ω–µ –∫–æ–¥—É–≤–∞–Ω–Ω—è/–¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
    - –ü–µ—Ä–µ–≤—ñ—Ä–∫—É –ª—ñ–º—ñ—Ç—É —É 64 –±–∞–π—Ç–∏ (–≤ UTF-8)
    """

    ns: str															# üì¶ –ü—Ä–æ—Å—Ç—ñ—Ä —ñ–º–µ–Ω, –Ω–∞–ø—Ä. "currency"
    name: str														# üè∑Ô∏è –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –¥—ñ—ó, –Ω–∞–ø—Ä. "show_rate"

    # ================================
    # üîß –ü–Ü–°–õ–Ø–Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø (–í–ê–õ–Ü–î–ê–¶–Ü–Ø)
    # ================================
    def __post_init__(self) -> None:
        """
        ‚úÖ –í–∞–ª—ñ–¥—É—î ns/name –æ–¥—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –æ–±'—î–∫—Ç–∞.
        –î–æ–∑–≤–æ–ª—è—é—Ç—å—Å—è –ª–∏—à–µ —Å–∏–º–≤–æ–ª–∏ [a-z0-9_:-], –¥–æ–≤–∂–∏–Ω–∞ ‚â§ 32; –±–µ–∑ '?', '&', '='.
        """
        ns = self.ns.strip().lower()										# üîΩ –ü—Ä–∏–≤–æ–¥–∏–º–æ –¥–æ –∫–∞–Ω–æ–Ω—ñ—á–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É
        name = self.name.strip().lower()										# üîΩ –ü—Ä–∏–≤–æ–¥–∏–º–æ –¥–æ –∫–∞–Ω–æ–Ω—ñ—á–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É

        if not (_NS_NAME_RE.match(ns) and _NS_NAME_RE.match(name)):			# üß™ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞—Ç–µ—Ä–Ω–æ–º
            raise ValueError(
                f"–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ ns/name: '{self.ns}:{self.name}'. "
                "–î–æ–∑–≤–æ–ª–µ–Ω–æ [a-z0-9_:-], –¥–æ–≤–∂–∏–Ω–∞ ‚â§ 32."
            )

        if any(ch in ns for ch in "?&=") or any(ch in name for ch in "?&="):	# üõë –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —Å–∏–º–≤–æ–ª–∏ –≤ –±–∞–∑–æ–≤—ñ–π —á–∞—Å—Ç–∏–Ω—ñ
            raise ValueError("ns —Ç–∞ name –Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ –º—ñ—Å—Ç–∏—Ç–∏ '?', '&', '='.")

        # –û—Å–∫—ñ–ª—å–∫–∏ dataclass frozen=True, –æ–Ω–æ–≤–ª—é—î–º–æ —á–µ—Ä–µ–∑ object.__setattr__
        object.__setattr__(self, "ns", ns)										# ‚ôªÔ∏è –§—ñ–∫—Å—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        object.__setattr__(self, "name", name)									# ‚ôªÔ∏è –§—ñ–∫—Å—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è

    # ================================
    # üÜî –ö–õ–Æ–ß –ë–ï–ó –ü–ê–†–ê–ú–ï–¢–†–Ü–í
    # ================================
    @property
    def key(self) -> str:
        """–ü–æ–≤–µ—Ä—Ç–∞—î –∫–ª—é—á —É —Ñ–æ—Ä–º–∞—Ç—ñ 'ns:name' –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤."""
        return f"{self.ns}:{self.name}"										# üîë –ë–∞–∑–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ callback_data

    # –ü–µ—Ä–µ—Ö—ñ–¥–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑—ñ —Å—Ç–∞—Ä–∏–º API: id() ‚Üí key
    def id(self) -> str:  # pragma: no cover
        """DEPRECATED: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ .key –∑–∞–º—ñ—Å—Ç—å .id()."""
        return self.key														# üß≠ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—É—á–∞—Å–Ω–∏–π –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç

    # ================================
    # üèóÔ∏è –ü–û–ë–£–î–û–í–ê –†–Ø–î–ö–ê CALLBACK_DATA
    # ================================
    def build(self, params: Optional[Mapping[str, str]] = None) -> str:
        """
        üèóÔ∏è –°—Ç–≤–æ—Ä—é—î —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä—è–¥–æ–∫ `callback_data` –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

        Args:
            params: –°–ª–æ–≤–Ω–∏–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –¥–ª—è –∫–æ–¥—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä., {"sku": "YLA-123"}).

        Returns:
            –†—è–¥–æ–∫, –≥–æ—Ç–æ–≤–∏–π –¥–ª—è `InlineKeyboardButton`.

        Raises:
            ValueError: –Ø–∫—â–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä—è–¥–æ–∫ –ø–µ—Ä–µ–≤–∏—â—É—î 64 –±–∞–π—Ç–∏.
        """
        base = self.key														# üîñ –ë–∞–∑–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ ns:name
        payload = base														# üì¶ –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤)

        if params:															# üßÆ –Ø–∫—â–æ —î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Äî –∫–æ–¥—É—î–º–æ query-–ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å
            # ‚úÖ –°—Ç–∞–±—ñ–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ (sorted) –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–æ—Å—Ç—ñ
            # safe=":_-" ‚Äî –∑–∞–ª–∏—à–∞—î –∫–æ—Ä–∏—Å–Ω—ñ —Å–∏–º–≤–æ–ª–∏ –Ω–µ–∫–æ–¥–æ–≤–∞–Ω–∏–º–∏ (—Ç–æ–Ω–∫–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥ –ø—Ä–æ—î–∫—Ç)
            query_string = urlencode(sorted(params.items()), doseq=False, safe=":_-")	# üîó –ü–æ–±—É–¥–æ–≤–∞ query string
            if query_string:												# üß∑ –î–æ–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –ø–∞—Ä–∏ –∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–Ω—è
                payload = f"{base}?{query_string}"							# üßµ –û–±'—î–¥–Ω—É—î–º–æ –±–∞–∑—É –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

        # ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º UTF‚Äë8
        if len(payload.encode("utf-8")) > TG_CALLBACK_MAX_BYTES:			# üìè Telegram –ª—ñ–º—ñ—Ç 64 –±–∞–π—Ç–∏
            raise ValueError(
                f"Callback data –ø–µ—Ä–µ–≤–∏—â—É—î –ª—ñ–º—ñ—Ç Telegram —É {TG_CALLBACK_MAX_BYTES} –±–∞–π—Ç: '{payload}'"
            )

        return payload														# ‚úÖ –ì–æ—Ç–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è InlineKeyboardButton

    # ================================
    # üìè –û–¶–Ü–ù–ö–ê ¬´–ë–Æ–î–ñ–ï–¢–£¬ª –ë–ê–ô–¢
    # ================================
    def budget_left(self, params: Optional[Mapping[str, str]] = None) -> int:
        """
        –ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–∞–π—Ç, —â–æ –∑–∞–ª–∏—à–∏–ª–∞—Å—å –¥–æ –ª—ñ–º—ñ—Ç—É 64B,
        —è–∫—â–æ –∑–∞–∫–æ–¥—É–≤–∞—Ç–∏ —Ä—è–¥–æ–∫ —ñ–∑ –ø–µ—Ä–µ–¥–∞–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
        """
        payload = self.build(params or {})									# üß™ –ï–º—É–ª—è—Ü—ñ—è —Ñ–∞–∫—Ç–∏—á–Ω–æ—ó –∑–±—ñ—Ä–∫–∏
        return TG_CALLBACK_MAX_BYTES - len(payload.encode("utf-8"))			# üìâ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ª–∏—à–∫—É –≤ –±–∞–π—Ç–∞—Ö

    # ================================
    # üß© –†–û–ó–ë–Ü–† –†–Ø–î–ö–ê CALLBACK_DATA
    # ================================
    @staticmethod
    def parse(raw_data: str) -> Tuple["CallbackData", Dict[str, str]]:
        """
        üß© –†–æ–∑–±–∏—Ä–∞—î —Ä—è–¥–æ–∫ `callback_data` –Ω–∞ –æ–±'—î–∫—Ç `CallbackData` —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.

        Args:
            raw_data: –í—Ö—ñ–¥–Ω–∏–π —Ä—è–¥–æ–∫ –≤—ñ–¥ Telegram.

        Returns:
            –ö–æ—Ä—Ç–µ–∂ `(CallbackData, —Å–ª–æ–≤–Ω–∏–∫_–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤)`.

        Raises:
            ValueError: –Ø–∫—â–æ —Ñ–æ—Ä–º–∞—Ç –±–∞–∑–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –Ω–µ `ns:name`.
        """
        params: Dict[str, str] = {}											# üóÇÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        base = raw_data														# üìÑ –ë–∞–∑–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ (–ø–æ–∫–∏ —â–æ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤)

        if "?" in raw_data:													# üîé –Ø–∫—â–æ —î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Äî –≤—ñ–¥—Ç–∏–Ω–∞—î–º–æ —ó—Ö
            base, query_part = raw_data.split("?", 1)						# ‚úÇÔ∏è –†–æ–∑–¥—ñ–ª—è—î–º–æ –Ω–∞ –±–∞–∑—É —Ç–∞ query
            # keep_blank_values=False: —ñ–≥–Ω–æ—Ä—É—î –ø–æ—Ä–æ–∂–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (?sku=)
            # strict_parsing=False: —ñ–≥–Ω–æ—Ä—É—î–º–æ –∫—Ä–∏–≤—ñ –ø–∞—Ä–∏, –Ω–µ –≤–∞–ª–∏–º–æ –ø–∞—Ä—Å–∏–Ω–≥
            parsed_qs = parse_qs(query_part, keep_blank_values=False, strict_parsing=False)	# üßµ –ü–∞—Ä—Å–∏–º–æ query
            params = {k: v[0] for k, v in parsed_qs.items() if v}			# „ÄΩÔ∏è –ë–µ—Ä–µ–º–æ –ª–∏—à–µ –ø–µ—Ä—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á–∞

        if ":" not in base:													# üõë –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É
            raise ValueError(
                "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç callback_data: –æ—á—ñ–∫—É—î—Ç—å—Å—è 'ns:name' (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤)."
            )

        ns, name = base.split(":", 1)										# üß≠ –í–∏—Ç—è–≥—É—î–º–æ namespace —ñ —ñ–º'—è –¥—ñ—ó
        return CallbackData(ns, name), params								# ‚úÖ –ì–æ—Ç–æ–≤–∏–π –æ–±'—î–∫—Ç —ñ —Å–ª–æ–≤–Ω–∏–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
