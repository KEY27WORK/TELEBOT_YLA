# üìä Metrics (Prometheus counters)

–ü–∞–∫–µ—Ç **`app/shared/metrics`** –º—ñ—Å—Ç–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è
–∑–∞—Å—Ç–æ—Å—É–Ω–∫–æ–º –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–Ω–∏—Ö, OCR —Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–æ–≤–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤. –¢–∞–∫–æ–∂
–≤–∫–ª—é—á–∞—î –ª–µ–≥–∫–∏–π bootstrap-–µ–∫—Å–ø–æ—Ä—Ç–µ—Ä `/metrics`.

## üì¶ –°–∫–ª–∞–¥

- `content.py` ‚Äî –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó ALT-—Ç–µ–∫—Å—Ç—ñ–≤:
  - `ALT_SUCCESS` ‚Äî —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ ALT-—Ç–µ–∫—Å—Ç–∏.
  - `ALT_FAILURE` ‚Äî –ø–æ–º–∏–ª–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó (—ñ–∑ –ø—Ä–∏—á–∏–Ω–æ—é).
  - `ALT_CACHE_HIT` ‚Äî –ø–æ–ø–∞–¥–∞–Ω–Ω—è –≤ –∫–µ—à ALT-—Ç–µ–∫—Å—Ç—ñ–≤.
- `ocr.py` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è OCR-–ø–∞–π–ø–ª–∞–π–Ω—ñ–≤:
  - `OCR_SUCCESS`, `OCR_FAILURE`, `OCR_CACHE_HIT`, `OCR_CACHE_MISS`.
- `parsing.py` ‚Äî –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥—É HTML:
  - `PARSING_SUCCESS` —Ç–∞ `PARSING_FAILURE` –∑ —Ç–µ–≥–∞–º–∏ `source`, `reason`.
- `exporters.py` ‚Äî `maybe_start_prometheus(port)` –¥–ª—è –∑–∞–ø—É—Å–∫—É HTTP-—Å–µ—Ä–≤–µ—Ä–∞ Prometheus.
- `__init__.py` ‚Äî –∞–≥—Ä–µ–≥—É—î –≤—Å—ñ –º–µ—Ç—Ä–∏–∫–∏ –π –µ–∫—Å–ø–æ—Ä—Ç–µ—Ä –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ —ñ–º–ø–æ—Ä—Ç—É.

```bash
üìä metrics/
‚îú‚îÄ‚îÄ üìò README.md          # –ø—É—Ç—ñ–≤–Ω–∏–∫ –ø–æ –º–µ—Ç—Ä–∏–∫–∞—Ö
‚îú‚îÄ‚îÄ üìÑ __init__.py        # –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –µ–∫—Å–ø–æ—Ä—Ç—É
‚îú‚îÄ‚îÄ üìÑ content.py         # ALT-—Ç–µ–∫—Å—Ç–∏
‚îú‚îÄ‚îÄ üìÑ exporters.py       # maybe_start_prometheus
‚îú‚îÄ‚îÄ üìÑ ocr.py             # OCR-–ø—Ä–æ—Ü–µ—Å–∏
‚îî‚îÄ‚îÄ üìÑ parsing.py         # HTML-–ø–∞—Ä—Å–∏–Ω–≥
```

## üß≠ –ü–æ—Ç–æ–∫–∏

- –ü—ñ—Å–ª—è —Å—Ç–∞—Ä—Ç—É –ø—Ä–æ—Ü–µ—Å—É –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `maybe_start_prometheus(port)` (—è–∫—â–æ –ø–æ—Ä—Ç –∑–∞–¥–∞–Ω–∏–π).
- –°–µ—Ä–≤—ñ—Å–∏ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ `Counter` —á–µ—Ä–µ–∑ —ñ–º–ø–æ—Ä—Ç —ñ–∑ –ø–∞–∫–µ—Ç—É:
  `from app.shared.metrics import ALT_SUCCESS, OCR_FAILURE, ...`.
- Prometheus-—Å–µ—Ä–≤–µ—Ä –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –∑–Ω—ñ–º–∞—î `/metrics`, –∑–±–∏—Ä–∞—é—á–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ —Å–∏—Å—Ç–µ–º–∏.

## üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø–∏

- **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å:** —Ç—ñ–ª—å–∫–∏ `prometheus_client`.
- **–Ø–≤–Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∞:** –∫–æ–∂–µ–Ω –ª—ñ—á–∏–ª—å–Ω–∏–∫ –º–∞—î —á–∏—Ç–∞–±–µ–ª—å–Ω—É –Ω–∞–∑–≤—É –π –æ–ø–∏—Å.
- **–ú—ñ—Ç–∫–∏:** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `source`, –∞ –¥–ª—è –ø–æ–º–∏–ª–æ–∫ ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤–æ `reason`.
- **Idempotent exporter:** `maybe_start_prometheus` —Å—Ç–∞—Ä—Ç—É—î —Å–µ—Ä–≤–µ—Ä –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑.

## ‚ö†Ô∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

- `port`: TCP-–ø–æ—Ä—Ç, –Ω–∞ —è–∫–æ–º—É –≤—ñ–¥–¥–∞—î—Ç—å—Å—è `/metrics`.
- –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ –Ω–µ —Å–∫–∏–¥–∞—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ ‚Äî –æ—á–∏—â–µ–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç—ñ –ø—Ä–æ—Ü–µ—Å—É.

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

- –ú–æ–∫–∏ `prometheus_client.Counter` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—ñ–≤.
- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏ –∑ –≥—ñ–ª–∫–æ—é `maybe_start_prometheus`, —â–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞—î —Å–µ—Ä–≤–µ—Ä –ø–æ–≤—Ç–æ—Ä–Ω–æ.
